<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Jorgon的技术空间</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Jorgon的技术空间">
<meta property="og:url" content="https://393698063.github.io/index.html">
<meta property="og:site_name" content="Jorgon的技术空间">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="jorgon">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Jorgon的技术空间" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="index.html" id="logo">Jorgon的技术空间</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="index.html" id="subtitle">总结，技术</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="index.html">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://393698063.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-MetricKIt监控APP性能" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="2022/09/27/MetricKIt%E7%9B%91%E6%8E%A7APP%E6%80%A7%E8%83%BD/" class="article-date">
  <time datetime="2022-09-27T02:57:45.000Z" itemprop="datePublished">2022-09-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="2022/09/27/MetricKIt%E7%9B%91%E6%8E%A7APP%E6%80%A7%E8%83%BD/">MetricKIt监控APP性能</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="目前的性能框架"><a href="#目前的性能框架" class="headerlink" title="目前的性能框架"></a>目前的性能框架</h2><h2 id="MetricKit简介"><a href="#MetricKit简介" class="headerlink" title="MetricKit简介"></a>MetricKit简介</h2><p>MetricKit是苹果在iOS13（2020）年推出的性能监测框架。<a href="https://developer.apple.com/videos/play/wwdc2020/10081/" target="_blank" rel="noopener">session</a><br>[apple文档]（<a href="https://developer.apple.com/documentation/metrickit?language=objc）" target="_blank" rel="noopener">https://developer.apple.com/documentation/metrickit?language=objc）</a><br>iOS14进行了优化。<br>使用MetricKit，您可以接收系统捕获的设备应用程序诊断以及电源和性能指标。该系统每天最多向注册的应用程序发送一次关于前24小时的度量报告，<br>并在iOS 15及更高版本和macOS 12及更高版中立即发送诊断报告。</p>
<p>MetricKit 将系统收集的数据交给开发者，让我们自己去决定如何利用这些数据去打造一个更省电、性能更好的 App。</p>
<p>该框架包括以下内容：<br>管理器类和订户协议<br>报告数据的有效载荷类别<br>每类度量和诊断的类<br>测量单位的类别，如蜂窝连接条<br>用于表示累积数据（如直方图）的类<br>用于在诊断中捕获堆栈跟踪的类</p>
<img src="2022/09/27/MetricKIt%E7%9B%91%E6%8E%A7APP%E6%80%A7%E8%83%BD/MetricKit.png" class="" title="This is an example image">

<h2 id="如何集成MetricKit"><a href="#如何集成MetricKit" class="headerlink" title="如何集成MetricKit"></a>如何集成MetricKit</h2><p>MetricKit 的接入基本属于无侵入，并且步骤十分简单</p>
<ol>
<li>获取 MXMetricManager 单例</li>
<li>注册数据接收对象</li>
<li>实现 delegate 回调<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">import UIKit</span><br><span class="line">import MetricKit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@objc class QGMetricKitManager: NSObject &#123;</span><br><span class="line">    @objc public static let shared &#x3D; QGMetricKitManager()</span><br><span class="line">    private override init() &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @available(iOS 13.0, *)</span><br><span class="line">    @objc func start() &#123;</span><br><span class="line">        let metricManager &#x3D; MXMetricManager.shared</span><br><span class="line">        metricManager.add(self);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extension QGMetricKitManager: MXMetricManagerSubscriber &#123;</span><br><span class="line">    @available(iOS 13.0, *)</span><br><span class="line">    func didReceive(_ payloads: [MXMetricPayload]) &#123;</span><br><span class="line">        guard let firtPayload &#x3D; payloads.first else &#123; return &#125;</span><br><span class="line">        print(firtPayload.dictionaryRepresentation())</span><br><span class="line">    &#125;</span><br><span class="line">    @available(iOS 14.0, *)</span><br><span class="line">    func didReceive(_ payloads: [MXDiagnosticPayload]) &#123;</span><br><span class="line">        guard let firtPayload &#x3D; payloads.first else &#123; return &#125;</span><br><span class="line">        print(firtPayload.dictionaryRepresentation())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="MetricKit如何工作"><a href="#MetricKit如何工作" class="headerlink" title="MetricKit如何工作"></a>MetricKit如何工作</h2><img src="2022/09/27/MetricKIt%E7%9B%91%E6%8E%A7APP%E6%80%A7%E8%83%BD/metricKitpayload.png" class="" title="This is an example image">
MetricKit 会在用户使用 App 的时候同步收集诊断信息，然后每天结束的时候将他们打包成 MXDiagnosticPayload 给到我们。这样我们就拥有了同一个时间段的性能数据和诊断数据。<img src="2022/09/27/MetricKIt%E7%9B%91%E6%8E%A7APP%E6%80%A7%E8%83%BD/MetricKitDiagnostic.png" class="" title="This is an example image">
由于他们是一一对应的，所以我们在对性能数据产生疑问的时候就可以掏出对应的诊断数据来进行排查。由于有了这些一一的对应关系，所以 MetricKit 2.0 也随之来了一些新的基类</li>
</ol>
<ul>
<li>MXDiagnostic ：所有诊断类集成的基类</li>
<li>MXDiagnosticPayload ：诊断包，包含一天结束时的所有诊断</li>
<li>MXCallStackTree ：新数据类，用于封装当前环境的调用栈<br>MXCallStackTree 封装的调用栈并没有经过符号化，旨在用于设备外处理，非 debug 用。转换成 JSON 后如下所示<img src="2022/09/27/MetricKIt%E7%9B%91%E6%8E%A7APP%E6%80%A7%E8%83%BD/MxCakkStackTree.png" class="" title="This is an example image">
如果想要了解怎么利用这些调用栈数据，可以观看 WWDC 2020 - 10057 Identify trends with the Power and Performance API[4].<a href="https://developer.apple.com/videos/play/wwdc2020/10057/" target="_blank" rel="noopener">sessions</a><h3 id="简单介绍下诊断类型"><a href="#简单介绍下诊断类型" class="headerlink" title="简单介绍下诊断类型"></a>简单介绍下诊断类型</h3><img src="2022/09/27/MetricKIt%E7%9B%91%E6%8E%A7APP%E6%80%A7%E8%83%BD/MetricKit2.0.png" class="" title="This is an example image">
挂起异常、CPU异常、磁盘写入异常、和崩溃</li>
</ul>
<ol>
<li>MXHangDiagnostic(App对用户输入长时间无反应)，包括以下诊断数据<br>Time spent hanging (app 无响应时间)<br>Backtrace of main thread（主线程回溯）</li>
<li>MXCPUExceptionDiagnostic(CPU 异常)包括以下诊断数据</li>
</ol>
<ul>
<li>CPU time consumed(CPU 使用时间)</li>
<li>T*otal sampled time（CPU 高利用率期间的总采样时间）</li>
<li>Backtrack of threads spining CPU(占用CPU时间的线程回溯)</li>
</ul>
<ol start="3">
<li>MXDiskWriteExceptionDiagnostic(磁盘写入异常诊断)包括以下诊断数据</li>
</ol>
<ul>
<li>Total write caused (导致异常的写入总数)</li>
<li>Backtrace of threads causing writes （异常的线程）<br>当App突破每天1GB的阀值时，系统就会生成这类诊断</li>
</ul>
<ol start="4">
<li>MXCrashDiagnostic ,</li>
</ol>
<ul>
<li>EXception type，code，and signal</li>
<li>Termination reason</li>
<li>VM In（for bad access crash）</li>
<li>Backtrack 藕粉crashing thread</li>
</ul>
<p>总而言之，MetricKit诊断，是一个强大的新工具，可以让你在真实的客户用例中，找到回归问题的根本原因，可以帮助我们将优化工作推向新的高度</p>
<h2 id="MetricKit优点"><a href="#MetricKit优点" class="headerlink" title="MetricKit优点"></a>MetricKit优点</h2><p>基于苹果原生能力，无额外的性能损耗</p>
<h2 id="MetricKit缺点"><a href="#MetricKit缺点" class="headerlink" title="MetricKit缺点"></a>MetricKit缺点</h2><p>只支持iOS13，iOS14以上的系统，<br>可能对于目前成熟的Crash捕获框架，信息还不够充分</p>
<h2 id="示例数据"><a href="#示例数据" class="headerlink" title="示例数据"></a>示例数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; MXMetricPayload</span><br><span class="line">[AnyHashable(&quot;applicationResponsivenessMetrics&quot;): &#123;</span><br><span class="line">    histogrammedAppHangTime &#x3D;     &#123;</span><br><span class="line">        histogramNumBuckets &#x3D; 3;</span><br><span class="line">        histogramValue &#x3D;         &#123;</span><br><span class="line">            0 &#x3D;             &#123;</span><br><span class="line">                bucketCount &#x3D; 50;</span><br><span class="line">                bucketEnd &#x3D; &quot;100 ms&quot;;</span><br><span class="line">                bucketStart &#x3D; &quot;0 ms&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">            1 &#x3D;             &#123;</span><br><span class="line">                bucketCount &#x3D; 60;</span><br><span class="line">                bucketEnd &#x3D; &quot;400 ms&quot;;</span><br><span class="line">                bucketStart &#x3D; &quot;100 ms&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">            2 &#x3D;             &#123;</span><br><span class="line">                bucketCount &#x3D; 30;</span><br><span class="line">                bucketEnd &#x3D; &quot;700 ms&quot;;</span><br><span class="line">                bucketStart &#x3D; &quot;400 ms&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;, AnyHashable(&quot;signpostMetrics&quot;): &lt;__NSArrayM 0x280119170&gt;(</span><br><span class="line">&#123;</span><br><span class="line">    signpostCategory &#x3D; TestSignpostCategory1;</span><br><span class="line">    signpostIntervalData &#x3D;     &#123;</span><br><span class="line">        histogrammedSignpostDurations &#x3D;         &#123;</span><br><span class="line">            histogramNumBuckets &#x3D; 3;</span><br><span class="line">            histogramValue &#x3D;             &#123;</span><br><span class="line">                0 &#x3D;                 &#123;</span><br><span class="line">                    bucketCount &#x3D; 50;</span><br><span class="line">                    bucketEnd &#x3D; &quot;100 ms&quot;;</span><br><span class="line">                    bucketStart &#x3D; &quot;0 ms&quot;;</span><br><span class="line">                &#125;;</span><br><span class="line">                1 &#x3D;                 &#123;</span><br><span class="line">                    bucketCount &#x3D; 60;</span><br><span class="line">                    bucketEnd &#x3D; &quot;400 ms&quot;;</span><br><span class="line">                    bucketStart &#x3D; &quot;100 ms&quot;;</span><br><span class="line">                &#125;;</span><br><span class="line">                2 &#x3D;                 &#123;</span><br><span class="line">                    bucketCount &#x3D; 30;</span><br><span class="line">                    bucketEnd &#x3D; &quot;700 ms&quot;;</span><br><span class="line">                    bucketStart &#x3D; &quot;400 ms&quot;;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        signpostAverageMemory &#x3D; &quot;100,000 kB&quot;;</span><br><span class="line">        signpostCumulativeCPUTime &#x3D; &quot;30,000 ms&quot;;</span><br><span class="line">        signpostCumulativeHitchTimeRatio &#x3D; &quot;50 ms per s&quot;;</span><br><span class="line">        signpostCumulativeLogicalWrites &#x3D; &quot;600 kB&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">    signpostName &#x3D; TestSignpostName1;</span><br><span class="line">    totalSignpostCount &#x3D; 30;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    signpostCategory &#x3D; TestSignpostCategory2;</span><br><span class="line">    signpostIntervalData &#x3D;     &#123;</span><br><span class="line">        histogrammedSignpostDurations &#x3D;         &#123;</span><br><span class="line">            histogramNumBuckets &#x3D; 3;</span><br><span class="line">            histogramValue &#x3D;             &#123;</span><br><span class="line">                0 &#x3D;                 &#123;</span><br><span class="line">                    bucketCount &#x3D; 60;</span><br><span class="line">                    bucketEnd &#x3D; &quot;200 ms&quot;;</span><br><span class="line">                    bucketStart &#x3D; &quot;0 ms&quot;;</span><br><span class="line">                &#125;;</span><br><span class="line">                1 &#x3D;                 &#123;</span><br><span class="line">                    bucketCount &#x3D; 70;</span><br><span class="line">                    bucketEnd &#x3D; &quot;300 ms&quot;;</span><br><span class="line">                    bucketStart &#x3D; &quot;201 ms&quot;;</span><br><span class="line">                &#125;;</span><br><span class="line">                2 &#x3D;                 &#123;</span><br><span class="line">                    bucketCount &#x3D; 80;</span><br><span class="line">                    bucketEnd &#x3D; &quot;500 ms&quot;;</span><br><span class="line">                    bucketStart &#x3D; &quot;301 ms&quot;;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        signpostAverageMemory &#x3D; &quot;60,000 kB&quot;;</span><br><span class="line">        signpostCumulativeCPUTime &#x3D; &quot;50,000 ms&quot;;</span><br><span class="line">        signpostCumulativeLogicalWrites &#x3D; &quot;700 kB&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">    signpostName &#x3D; TestSignpostName2;</span><br><span class="line">    totalSignpostCount &#x3D; 40;</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line">, AnyHashable(&quot;applicationLaunchMetrics&quot;): &#123;</span><br><span class="line">    histogrammedResumeTime &#x3D;     &#123;</span><br><span class="line">        histogramNumBuckets &#x3D; 3;</span><br><span class="line">        histogramValue &#x3D;         &#123;</span><br><span class="line">            0 &#x3D;             &#123;</span><br><span class="line">                bucketCount &#x3D; 60;</span><br><span class="line">                bucketEnd &#x3D; &quot;210 ms&quot;;</span><br><span class="line">                bucketStart &#x3D; &quot;200 ms&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">            1 &#x3D;             &#123;</span><br><span class="line">                bucketCount &#x3D; 70;</span><br><span class="line">                bucketEnd &#x3D; &quot;310 ms&quot;;</span><br><span class="line">                bucketStart &#x3D; &quot;300 ms&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">            2 &#x3D;             &#123;</span><br><span class="line">                bucketCount &#x3D; 80;</span><br><span class="line">                bucketEnd &#x3D; &quot;510 ms&quot;;</span><br><span class="line">                bucketStart &#x3D; &quot;500 ms&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    histogrammedTimeToFirstDrawKey &#x3D;     &#123;</span><br><span class="line">        histogramNumBuckets &#x3D; 3;</span><br><span class="line">        histogramValue &#x3D;         &#123;</span><br><span class="line">            0 &#x3D;             &#123;</span><br><span class="line">                bucketCount &#x3D; 50;</span><br><span class="line">                bucketEnd &#x3D; &quot;1,010 ms&quot;;</span><br><span class="line">                bucketStart &#x3D; &quot;1,000 ms&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">            1 &#x3D;             &#123;</span><br><span class="line">                bucketCount &#x3D; 60;</span><br><span class="line">                bucketEnd &#x3D; &quot;2,010 ms&quot;;</span><br><span class="line">                bucketStart &#x3D; &quot;2,000 ms&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">            2 &#x3D;             &#123;</span><br><span class="line">                bucketCount &#x3D; 30;</span><br><span class="line">                bucketEnd &#x3D; &quot;3,010 ms&quot;;</span><br><span class="line">                bucketStart &#x3D; &quot;3,000 ms&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;, AnyHashable(&quot;cellularConditionMetrics&quot;): &#123;</span><br><span class="line">    cellConditionTime &#x3D;     &#123;</span><br><span class="line">        histogramNumBuckets &#x3D; 3;</span><br><span class="line">        histogramValue &#x3D;         &#123;</span><br><span class="line">            0 &#x3D;             &#123;</span><br><span class="line">                bucketCount &#x3D; 20;</span><br><span class="line">                bucketEnd &#x3D; &quot;1 bars&quot;;</span><br><span class="line">                bucketStart &#x3D; &quot;1 bars&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">            1 &#x3D;             &#123;</span><br><span class="line">                bucketCount &#x3D; 30;</span><br><span class="line">                bucketEnd &#x3D; &quot;2 bars&quot;;</span><br><span class="line">                bucketStart &#x3D; &quot;2 bars&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">            2 &#x3D;             &#123;</span><br><span class="line">                bucketCount &#x3D; 50;</span><br><span class="line">                bucketEnd &#x3D; &quot;3 bars&quot;;</span><br><span class="line">                bucketStart &#x3D; &quot;3 bars&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;, AnyHashable(&quot;timeStampEnd&quot;): 2022-09-27 15:59:00 +0000, AnyHashable(&quot;metaData&quot;): &#123;</span><br><span class="line">    appBuildVersion &#x3D; 1;</span><br><span class="line">    bundleIdentifier &#x3D; &quot;com.baidu.ALALiveSDKDebug&quot;;</span><br><span class="line">    deviceType &#x3D; &quot;iPhone11,2&quot;;</span><br><span class="line">    osVersion &#x3D; &quot;iPhone OS 15.1 (19B74)&quot;;</span><br><span class="line">    platformArchitecture &#x3D; arm64e;</span><br><span class="line">    regionFormat &#x3D; CN;</span><br><span class="line">&#125;, AnyHashable(&quot;displayMetrics&quot;): &#123;</span><br><span class="line">    averagePixelLuminance &#x3D;     &#123;</span><br><span class="line">        averageValue &#x3D; &quot;50 apl&quot;;</span><br><span class="line">        sampleCount &#x3D; 500;</span><br><span class="line">        standardDeviation &#x3D; 0;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;, AnyHashable(&quot;locationActivityMetrics&quot;): &#123;</span><br><span class="line">    cumulativeBestAccuracyForNavigationTime &#x3D; &quot;20 sec&quot;;</span><br><span class="line">    cumulativeBestAccuracyTime &#x3D; &quot;30 sec&quot;;</span><br><span class="line">    cumulativeHundredMetersAccuracyTime &#x3D; &quot;30 sec&quot;;</span><br><span class="line">    cumulativeKilometerAccuracyTime &#x3D; &quot;20 sec&quot;;</span><br><span class="line">    cumulativeNearestTenMetersAccuracyTime &#x3D; &quot;30 sec&quot;;</span><br><span class="line">    cumulativeThreeKilometersAccuracyTime &#x3D; &quot;20 sec&quot;;</span><br><span class="line">&#125;, AnyHashable(&quot;gpuMetrics&quot;): &#123;</span><br><span class="line">    cumulativeGPUTime &#x3D; &quot;20 sec&quot;;</span><br><span class="line">&#125;, AnyHashable(&quot;timeStampBegin&quot;): 2022-09-26 16:00:00 +0000, AnyHashable(&quot;appVersion&quot;): 1.0, AnyHashable(&quot;cpuMetrics&quot;): &#123;</span><br><span class="line">    cumulativeCPUInstructions &#x3D; &quot;100 kiloinstructions&quot;;</span><br><span class="line">    cumulativeCPUTime &#x3D; &quot;100 sec&quot;;</span><br><span class="line">&#125;, AnyHashable(&quot;applicationExitMetrics&quot;): &#123;</span><br><span class="line">    backgroundExitData &#x3D;     &#123;</span><br><span class="line">        cumulativeAbnormalExitCount &#x3D; 1;</span><br><span class="line">        cumulativeAppWatchdogExitCount &#x3D; 1;</span><br><span class="line">        cumulativeBackgroundFetchCompletionTimeoutExitCount &#x3D; 1;</span><br><span class="line">        cumulativeBackgroundTaskAssertionTimeoutExitCount &#x3D; 1;</span><br><span class="line">        cumulativeBackgroundURLSessionCompletionTimeoutExitCount &#x3D; 1;</span><br><span class="line">        cumulativeBadAccessExitCount &#x3D; 1;</span><br><span class="line">        cumulativeCPUResourceLimitExitCount &#x3D; 1;</span><br><span class="line">        cumulativeIllegalInstructionExitCount &#x3D; 1;</span><br><span class="line">        cumulativeMemoryPressureExitCount &#x3D; 1;</span><br><span class="line">        cumulativeMemoryResourceLimitExitCount &#x3D; 1;</span><br><span class="line">        cumulativeNormalAppExitCount &#x3D; 1;</span><br><span class="line">        cumulativeSuspendedWithLockedFileExitCount &#x3D; 1;</span><br><span class="line">    &#125;;</span><br><span class="line">    foregroundExitData &#x3D;     &#123;</span><br><span class="line">        cumulativeAbnormalExitCount &#x3D; 1;</span><br><span class="line">        cumulativeAppWatchdogExitCount &#x3D; 1;</span><br><span class="line">        cumulativeBadAccessExitCount &#x3D; 1;</span><br><span class="line">        cumulativeCPUResourceLimitExitCount &#x3D; 1;</span><br><span class="line">        cumulativeIllegalInstructionExitCount &#x3D; 1;</span><br><span class="line">        cumulativeMemoryResourceLimitExitCount &#x3D; 1;</span><br><span class="line">        cumulativeNormalAppExitCount &#x3D; 1;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;, AnyHashable(&quot;diskIOMetrics&quot;): &#123;</span><br><span class="line">    cumulativeLogicalWrites &#x3D; &quot;1,300 kB&quot;;</span><br><span class="line">&#125;, AnyHashable(&quot;memoryMetrics&quot;): &#123;</span><br><span class="line">    averageSuspendedMemory &#x3D;     &#123;</span><br><span class="line">        averageValue &#x3D; &quot;100,000 kB&quot;;</span><br><span class="line">        sampleCount &#x3D; 500;</span><br><span class="line">        standardDeviation &#x3D; 0;</span><br><span class="line">    &#125;;</span><br><span class="line">    peakMemoryUsage &#x3D; &quot;200,000 kB&quot;;</span><br><span class="line">&#125;, AnyHashable(&quot;animationMetrics&quot;): &#123;</span><br><span class="line">    scrollHitchTimeRatio &#x3D; &quot;1,000 ms per s&quot;;</span><br><span class="line">&#125;, AnyHashable(&quot;networkTransferMetrics&quot;): &#123;</span><br><span class="line">    cumulativeCellularDownload &#x3D; &quot;80,000 kB&quot;;</span><br><span class="line">    cumulativeCellularUpload &#x3D; &quot;70,000 kB&quot;;</span><br><span class="line">    cumulativeWifiDownload &#x3D; &quot;60,000 kB&quot;;</span><br><span class="line">    cumulativeWifiUpload &#x3D; &quot;50,000 kB&quot;;</span><br><span class="line">&#125;, AnyHashable(&quot;applicationTimeMetrics&quot;): &#123;</span><br><span class="line">    cumulativeBackgroundAudioTime &#x3D; &quot;30 sec&quot;;</span><br><span class="line">    cumulativeBackgroundLocationTime &#x3D; &quot;30 sec&quot;;</span><br><span class="line">    cumulativeBackgroundTime &#x3D; &quot;40 sec&quot;;</span><br><span class="line">    cumulativeForegroundTime &#x3D; &quot;700 sec&quot;;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">MXDiagnosticPayload</span><br><span class="line">[AnyHashable(&quot;hangDiagnostics&quot;): &lt;__NSArrayM 0x280b68720&gt;(</span><br><span class="line">&#123;</span><br><span class="line">    callStackTree &#x3D;     &#123;</span><br><span class="line">        callStackPerThread &#x3D; 1;</span><br><span class="line">        callStacks &#x3D;         (</span><br><span class="line">                        &#123;</span><br><span class="line">                callStackRootFrames &#x3D;                 (</span><br><span class="line">                                        &#123;</span><br><span class="line">                        address &#x3D; 74565;</span><br><span class="line">                        binaryName &#x3D; testBinaryName;</span><br><span class="line">                        binaryUUID &#x3D; &quot;DDD90555-7FB2-4CC5-861B-4E4E35370FD2&quot;;</span><br><span class="line">                        offsetIntoBinaryTextSegment &#x3D; 123;</span><br><span class="line">                        sampleCount &#x3D; 20;</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">                threadAttributed &#x3D; 1;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;;</span><br><span class="line">    diagnosticMetaData &#x3D;     &#123;</span><br><span class="line">        appBuildVersion &#x3D; 1;</span><br><span class="line">        appVersion &#x3D; &quot;1.0&quot;;</span><br><span class="line">        bundleIdentifier &#x3D; &quot;com.baidu.ALALiveSDKDebug&quot;;</span><br><span class="line">        deviceType &#x3D; &quot;iPhone11,2&quot;;</span><br><span class="line">        hangDuration &#x3D; &quot;20 sec&quot;;</span><br><span class="line">        osVersion &#x3D; &quot;iPhone OS 15.1 (19B74)&quot;;</span><br><span class="line">        platformArchitecture &#x3D; arm64e;</span><br><span class="line">        regionFormat &#x3D; CN;</span><br><span class="line">    &#125;;</span><br><span class="line">    version &#x3D; &quot;1.0.0&quot;;</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line">, AnyHashable(&quot;cpuExceptionDiagnostics&quot;): &lt;__NSArrayM 0x280b686f0&gt;(</span><br><span class="line">&#123;</span><br><span class="line">    callStackTree &#x3D;     &#123;</span><br><span class="line">        callStackPerThread &#x3D; 0;</span><br><span class="line">        callStacks &#x3D;         (</span><br><span class="line">                        &#123;</span><br><span class="line">                callStackRootFrames &#x3D;                 (</span><br><span class="line">                                        &#123;</span><br><span class="line">                        address &#x3D; 74565;</span><br><span class="line">                        binaryName &#x3D; testBinaryName;</span><br><span class="line">                        binaryUUID &#x3D; &quot;C55495DA-8EC5-473A-8127-435E932B0B4B&quot;;</span><br><span class="line">                        offsetIntoBinaryTextSegment &#x3D; 123;</span><br><span class="line">                        sampleCount &#x3D; 20;</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;;</span><br><span class="line">    diagnosticMetaData &#x3D;     &#123;</span><br><span class="line">        appBuildVersion &#x3D; 1;</span><br><span class="line">        appVersion &#x3D; &quot;1.0&quot;;</span><br><span class="line">        bundleIdentifier &#x3D; &quot;com.baidu.ALALiveSDKDebug&quot;;</span><br><span class="line">        deviceType &#x3D; &quot;iPhone11,2&quot;;</span><br><span class="line">        osVersion &#x3D; &quot;iPhone OS 15.1 (19B74)&quot;;</span><br><span class="line">        platformArchitecture &#x3D; arm64e;</span><br><span class="line">        regionFormat &#x3D; CN;</span><br><span class="line">        totalCPUTime &#x3D; &quot;20 sec&quot;;</span><br><span class="line">        totalSampledTime &#x3D; &quot;20 sec&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">    version &#x3D; &quot;1.0.0&quot;;</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line">, AnyHashable(&quot;crashDiagnostics&quot;): &lt;__NSArrayM 0x280b689c0&gt;(</span><br><span class="line">&#123;</span><br><span class="line">    callStackTree &#x3D;     &#123;</span><br><span class="line">        callStackPerThread &#x3D; 1;</span><br><span class="line">        callStacks &#x3D;         (</span><br><span class="line">                        &#123;</span><br><span class="line">                callStackRootFrames &#x3D;                 (</span><br><span class="line">                                        &#123;</span><br><span class="line">                        address &#x3D; 74565;</span><br><span class="line">                        binaryName &#x3D; testBinaryName;</span><br><span class="line">                        binaryUUID &#x3D; &quot;DDD90555-7FB2-4CC5-861B-4E4E35370FD2&quot;;</span><br><span class="line">                        offsetIntoBinaryTextSegment &#x3D; 123;</span><br><span class="line">                        sampleCount &#x3D; 20;</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">                threadAttributed &#x3D; 1;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;;</span><br><span class="line">    diagnosticMetaData &#x3D;     &#123;</span><br><span class="line">        appBuildVersion &#x3D; 1;</span><br><span class="line">        appVersion &#x3D; &quot;1.0&quot;;</span><br><span class="line">        bundleIdentifier &#x3D; &quot;com.baidu.ALALiveSDKDebug&quot;;</span><br><span class="line">        deviceType &#x3D; &quot;iPhone11,2&quot;;</span><br><span class="line">        exceptionCode &#x3D; 0;</span><br><span class="line">        exceptionType &#x3D; 1;</span><br><span class="line">        osVersion &#x3D; &quot;iPhone OS 15.1 (19B74)&quot;;</span><br><span class="line">        platformArchitecture &#x3D; arm64e;</span><br><span class="line">        regionFormat &#x3D; CN;</span><br><span class="line">        signal &#x3D; 11;</span><br><span class="line">        terminationReason &#x3D; &quot;Namespace SIGNAL, Code 0xb&quot;;</span><br><span class="line">        virtualMemoryRegionInfo &#x3D; &quot;0 is not in any region.  Bytes before following region: 4000000000 REGION TYPE                      START - END             [ VSIZE] PRT&#x2F;MAX SHRMOD  REGION DETAIL UNUSED SPACE AT START ---&gt; __TEXT                 0000000000000000-0000000000000000 [   32K] r-x&#x2F;r-x SM&#x3D;COW  ...pp&#x2F;Test&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">    version &#x3D; &quot;1.0.0&quot;;</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line">, AnyHashable(&quot;diskWriteExceptionDiagnostics&quot;): &lt;__NSArrayM 0x280b687b0&gt;(</span><br><span class="line">&#123;</span><br><span class="line">    callStackTree &#x3D;     &#123;</span><br><span class="line">        callStackPerThread &#x3D; 0;</span><br><span class="line">        callStacks &#x3D;         (</span><br><span class="line">                        &#123;</span><br><span class="line">                callStackRootFrames &#x3D;                 (</span><br><span class="line">                                        &#123;</span><br><span class="line">                        address &#x3D; 74565;</span><br><span class="line">                        binaryName &#x3D; testBinaryName;</span><br><span class="line">                        binaryUUID &#x3D; &quot;C55495DA-8EC5-473A-8127-435E932B0B4B&quot;;</span><br><span class="line">                        offsetIntoBinaryTextSegment &#x3D; 123;</span><br><span class="line">                        sampleCount &#x3D; 20;</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;;</span><br><span class="line">    diagnosticMetaData &#x3D;     &#123;</span><br><span class="line">        appBuildVersion &#x3D; 1;</span><br><span class="line">        appVersion &#x3D; &quot;1.0&quot;;</span><br><span class="line">        bundleIdentifier &#x3D; &quot;com.baidu.ALALiveSDKDebug&quot;;</span><br><span class="line">        deviceType &#x3D; &quot;iPhone11,2&quot;;</span><br><span class="line">        osVersion &#x3D; &quot;iPhone OS 15.1 (19B74)&quot;;</span><br><span class="line">        platformArchitecture &#x3D; arm64e;</span><br><span class="line">        regionFormat &#x3D; CN;</span><br><span class="line">        writesCaused &#x3D; &quot;2,000 byte&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">    version &#x3D; &quot;1.0.0&quot;;</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line">, AnyHashable(&quot;timeStampBegin&quot;): 2022-09-28 01:41:59 +0000, AnyHashable(&quot;timeStampEnd&quot;): 2022-09-28 01:41:59 +0000]</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://393698063.github.io/2022/09/27/MetricKIt%E7%9B%91%E6%8E%A7APP%E6%80%A7%E8%83%BD/" data-id="claw83fqh0008ab9jdb680kon" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-暗黑模式一" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="2022/08/25/%E6%9A%97%E9%BB%91%E6%A8%A1%E5%BC%8F%E4%B8%80/" class="article-date">
  <time datetime="2022-08-25T08:01:09.000Z" itemprop="datePublished">2022-08-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="2022/08/25/%E6%9A%97%E9%BB%91%E6%A8%A1%E5%BC%8F%E4%B8%80/">暗黑模式一</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p>从 iOS 13.0 版本开始，用户可以选择采用系统范围内的浅色或深色外观。 深色外观（称为暗黑模式DarkMode）实现了许多应用程序已经采用的界面样式。 用户可以选择自己喜欢的美学，也可以选择根据环境照明条件或特定时间表来切换其界面。苹果强烈建议支持深色模式。</p>
<h2 id="二、支持暗黑模式"><a href="#二、支持暗黑模式" class="headerlink" title="二、支持暗黑模式"></a>二、支持暗黑模式</h2><p>1.在Assets中添加自定义颜色</p>
<p>3.更新自定义视图的具体方法<br>当用户更改系统外观时，系统会自动要求每个窗口和视图重绘自身。 在此过程中，系统将调用下表中列出的几种众所周知的方法来更新您的内容。 系统在调用这些方法之前会更新特征环境，因此，如果要进行了所有外观敏感的更改，则应用程序会正确的进行更新。</p>
<p>UIView:<br>-traitCollectionDidChange:<br>-layoutSubviews<br>-drawRect:<br>-updateConstraints<br>-tintColorDidChange</p>
<p>UIViewController:<br>-traitCollectionDidChange:<br>-updateViewConstraints<br>-viewWillLayoutSubviews<br>-viewDidLayoutSubviews</p>
<p>UIPresentationController:<br>-traitCollectionDidChange:<br>-containerViewWillLayoutSubviews<br>-containerViewDidLayoutSubviews<br>当用户在明暗界面之间切换时，系统会要求你的应用重新绘制所有内容。虽然系统管理绘图过程，但在绘图过程中的几个点上，它依赖于您的自定义代码。您的代码必须尽可能快，并且不能执行与外观变化无关的任务。<br>如果需要根据当前模式的变化来修改界面，可以重写traitCollectionDidChange:方法进行更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (void) traitCollectionDidChange:(UITraitCollection *)previousTraitCollection</span><br><span class="line">&#123;</span><br><span class="line">    [super traitCollectionDidChange:previousTraitCollection];</span><br><span class="line">    UIUserInterfaceStyle userInterfaceStyle &#x3D; previousTraitCollection.userInterfaceStyle;</span><br><span class="line">    &#x2F;&#x2F; 更新视图</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而并不是每次系统调用traitCollectionDidChange:方法时，模式都有变化，也有可能是设备进行了旋转也会调用traitCollectionDidChange:方法，所以此时需要判断系统主题模式是否发生了改变</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (void) traitCollectionDidChange:(UITraitCollection *)previousTraitCollection</span><br><span class="line">&#123;</span><br><span class="line">    [super traitCollectionDidChange:previousTraitCollection];</span><br><span class="line">    </span><br><span class="line">    UITraitCollection *traitCollection &#x3D; [UITraitCollection currentTraitCollection];&#x2F;&#x2F; 获取当前的TraitCollection</span><br><span class="line">    BOOL hasUserInterfaceStyleChanged &#x3D; [previousTraitCollection hasDifferentColorAppearanceComparedToTraitCollection:traitCollection];</span><br><span class="line">    &#x2F;&#x2F; 根据当前模式更新视图</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、禁止暗黑模式"><a href="#三、禁止暗黑模式" class="headerlink" title="三、禁止暗黑模式"></a>三、禁止暗黑模式</h2><p>1、全局整个应用<br>可以在info.list中加入键值对UIUserInterfaceStyle对应值为Light字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;key&gt;UIUserInterfaceStyle&lt;&#x2F;key&gt; &lt;string&gt;Light&lt;&#x2F;string&gt;</span><br></pre></td></tr></table></figure>
<p>苹果强烈建议支持暗黑模式。当你致力于改善应用程序的暗模式支持时可以使用UIUserInterfaceStyle键来暂时来退出暗黑模式。<br>2、具体的UIViewController、UIView、UIWindow可以使用overrideUserInterfaceStyle属性来设置，通过overrideUserInterfaceStyle可以独立、灵活的设置应用、界面和视图的模式。</p>
<p>从iOS 13.0 开始UIViewController、UIView、UIWindow类都新增overrideUserInterfaceStyle属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic) UIUserInterfaceStyle overrideUserInterfaceStyle API_AVAILABLE(ios(13.0), tvos(13.0)) API_UNAVAILABLE(watchos);</span><br></pre></td></tr></table></figure>
<p>UIUserInterfaceStyle枚举类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef NS_ENUM(NSInteger, UIUserInterfaceStyle) &#123;</span><br><span class="line">    UIUserInterfaceStyleUnspecified,</span><br><span class="line">    UIUserInterfaceStyleLight,</span><br><span class="line">    UIUserInterfaceStyleDark,</span><br><span class="line">&#125; API_AVAILABLE(tvos(10.0)) API_AVAILABLE(ios(12.0)) API_UNAVAILABLE(watchos);</span><br></pre></td></tr></table></figure>
<p>设置当前窗口的模式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (IBAction)changeModeAction:(id)sender &#123;</span><br><span class="line">    UIWindow *keyWindow &#x3D; [UIApplication sharedApplication].windows.firstObject;</span><br><span class="line">    if (keyWindow.overrideUserInterfaceStyle &#x3D;&#x3D; UIUserInterfaceStyleDark)   </span><br><span class="line">   &#123;</span><br><span class="line">        keyWindow.overrideUserInterfaceStyle &#x3D; UIUserInterfaceStyleLight;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        keyWindow.overrideUserInterfaceStyle &#x3D; UIUserInterfaceStyleDark;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置具体视图控制器的模式：<br> (void)viewDidLoad {<br>    [super viewDidLoad];<br>    self.overrideUserInterfaceStyle = UIUserInterfaceStyleLight;<br>}</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://393698063.github.io/2022/08/25/%E6%9A%97%E9%BB%91%E6%A8%A1%E5%BC%8F%E4%B8%80/" data-id="claw83fqk000cab9jah1j9fwn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-KSCrash-源码阅读-6-zoombie-class" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-6-zoombie-class/" class="article-date">
  <time datetime="2022-04-11T13:35:59.000Z" itemprop="datePublished">2022-04-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-6-zoombie-class/">KSCrash-源码阅读-6 zoombie_class</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="检测原理"><a href="#检测原理" class="headerlink" title="检测原理"></a>检测原理</h2><p>hook 对象的dealloc 方法，将释放的对象保存为僵尸对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">#define CREATE_ZOMBIE_HANDLER_INSTALLER(CLASS) \</span><br><span class="line">static IMP g_originalDealloc_ ## CLASS; \</span><br><span class="line">static void handleDealloc_ ## CLASS(id self, SEL _cmd) \</span><br><span class="line">&#123; \</span><br><span class="line">    handleDealloc(self); \</span><br><span class="line">    typedef void (*fn)(id,SEL); \</span><br><span class="line">    fn f &#x3D; (fn)g_originalDealloc_ ## CLASS; \</span><br><span class="line">    f(self, _cmd); \</span><br><span class="line">&#125; \</span><br><span class="line">static void installDealloc_ ## CLASS() \</span><br><span class="line">&#123; \</span><br><span class="line">    Method method &#x3D; class_getInstanceMethod(objc_getClass(#CLASS), sel_registerName(&quot;dealloc&quot;)); \</span><br><span class="line">    g_originalDealloc_ ## CLASS &#x3D; method_getImplementation(method); \</span><br><span class="line">    method_setImplementation(method, (IMP)handleDealloc_ ## CLASS); \</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; TODO: Uninstall doesn&#39;t work.</span><br><span class="line">&#x2F;&#x2F;static void uninstallDealloc_ ## CLASS() \</span><br><span class="line">&#x2F;&#x2F;&#123; \</span><br><span class="line">&#x2F;&#x2F;    method_setImplementation(class_getInstanceMethod(objc_getClass(#CLASS), sel_registerName(&quot;dealloc&quot;)), g_originalDealloc_ ## CLASS); \</span><br><span class="line">&#x2F;&#x2F;&#125;</span><br><span class="line"></span><br><span class="line">CREATE_ZOMBIE_HANDLER_INSTALLER(NSObject)</span><br><span class="line">CREATE_ZOMBIE_HANDLER_INSTALLER(NSProxy)</span><br><span class="line"></span><br><span class="line">static void install()</span><br><span class="line">&#123;</span><br><span class="line">    unsigned cacheSize &#x3D; CACHE_SIZE;</span><br><span class="line">    g_zombieHashMask &#x3D; cacheSize - 1;</span><br><span class="line">    g_zombieCache &#x3D; calloc(cacheSize, sizeof(*g_zombieCache));</span><br><span class="line">    if(g_zombieCache &#x3D;&#x3D; NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        KSLOG_ERROR(&quot;Error: Could not allocate %u bytes of memory. KSZombie NOT installed!&quot;,</span><br><span class="line">              cacheSize * sizeof(*g_zombieCache));</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    g_lastDeallocedException.class &#x3D; objc_getClass(&quot;NSException&quot;);</span><br><span class="line">    g_lastDeallocedException.address &#x3D; NULL;</span><br><span class="line">    g_lastDeallocedException.name[0] &#x3D; 0;</span><br><span class="line">    g_lastDeallocedException.reason[0] &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    installDealloc_NSObject();</span><br><span class="line">    installDealloc_NSProxy();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void handleDealloc(const void* self)</span><br><span class="line">&#123;</span><br><span class="line">    volatile Zombie* cache &#x3D; g_zombieCache;</span><br><span class="line">    likely_if(cache !&#x3D; NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        Zombie* zombie &#x3D; (Zombie*)cache + hashIndex(self);</span><br><span class="line">        zombie-&gt;object &#x3D; self;</span><br><span class="line">        Class class &#x3D; object_getClass((id)self);</span><br><span class="line">        zombie-&gt;className &#x3D; class_getName(class);</span><br><span class="line">        for(; class !&#x3D; nil; class &#x3D; class_getSuperclass(class))</span><br><span class="line">        &#123;</span><br><span class="line">            unlikely_if(class &#x3D;&#x3D; g_lastDeallocedException.class)</span><br><span class="line">            &#123;</span><br><span class="line">                storeException(self);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.jianshu.com/p/7bb92761f2f5" target="_blank" rel="noopener">iOS使用Zombie Objects检测僵尸对象及其原理</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://393698063.github.io/2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-6-zoombie-class/" data-id="claw83fqe0005ab9jcktx2vgu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-KSCrash-源码阅读-5-Dead-lock" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-5-Dead-lock/" class="article-date">
  <time datetime="2022-04-11T12:47:08.000Z" itemprop="datePublished">2022-04-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-5-Dead-lock/">KSCrash-源码阅读-5 Dead lock</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="检测原理"><a href="#检测原理" class="headerlink" title="检测原理"></a>检测原理</h2><p>主线程死锁的检测和 ANR 的检测有些类似</p>
<p>创建一个线程，在线程运行方法中用 do…while… 循环处理逻辑，加了 autorelease 避免内存过高</p>
<p>有一个 awaitingResponse 属性和 watchdogPulse 方法。watchdogPulse 主要逻辑为设置 awaitingResponse 为 YES，切换到主线程中，设置 awaitingResponse 为 NO，</p>
<p>线程的执行方法里面不断循环，等待设置的 g_watchdogInterval 后判断 awaitingResponse 的属性值是不是初始状态的值，否则判断为死锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">- (id) init</span><br><span class="line">&#123;</span><br><span class="line">    if((self &#x3D; [super init]))</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; target (self) is retained until selector (runMonitor) exits.</span><br><span class="line">        self.monitorThread &#x3D; [[NSThread alloc] initWithTarget:self selector:@selector(runMonitor) object:nil];</span><br><span class="line">        self.monitorThread.name &#x3D; @&quot;KSCrash Deadlock Detection Thread&quot;;</span><br><span class="line">        [self.monitorThread start];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void) runMonitor</span><br><span class="line">&#123;</span><br><span class="line">    BOOL cancelled &#x3D; NO;</span><br><span class="line">    do</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; Only do a watchdog check if the watchdog interval is &gt; 0.</span><br><span class="line">        &#x2F;&#x2F; If the interval is &lt;&#x3D; 0, just idle until the user changes it.</span><br><span class="line">        @autoreleasepool &#123;</span><br><span class="line">            NSTimeInterval sleepInterval &#x3D; g_watchdogInterval;</span><br><span class="line">            BOOL runWatchdogCheck &#x3D; sleepInterval &gt; 0;</span><br><span class="line">            if(!runWatchdogCheck)</span><br><span class="line">            &#123;</span><br><span class="line">                sleepInterval &#x3D; kIdleInterval;</span><br><span class="line">            &#125;</span><br><span class="line">            [NSThread sleepForTimeInterval:sleepInterval];</span><br><span class="line">            cancelled &#x3D; self.monitorThread.isCancelled;</span><br><span class="line">            if(!cancelled &amp;&amp; runWatchdogCheck)</span><br><span class="line">            &#123;</span><br><span class="line">                if(self.awaitingResponse)</span><br><span class="line">                &#123;</span><br><span class="line">                    [self handleDeadlock];</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    [self watchdogPulse];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; while (!cancelled);</span><br><span class="line">&#125;</span><br><span class="line">- (void) watchdogPulse</span><br><span class="line">&#123;</span><br><span class="line">    __block id blockSelf &#x3D; self;</span><br><span class="line">    self.awaitingResponse &#x3D; YES;</span><br><span class="line">    dispatch_async(dispatch_get_main_queue(), ^</span><br><span class="line">                   &#123;</span><br><span class="line">                       [blockSelf watchdogAnswer];</span><br><span class="line">                   &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="处理异常"><a href="#处理异常" class="headerlink" title="处理异常"></a>处理异常</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (void) handleDeadlock</span><br><span class="line">&#123;</span><br><span class="line">    thread_act_array_t threads &#x3D; NULL;</span><br><span class="line">    mach_msg_type_number_t numThreads &#x3D; 0;</span><br><span class="line">    ksmc_suspendEnvironment(&amp;threads, &amp;numThreads);</span><br><span class="line">    kscm_notifyFatalExceptionCaptured(false);</span><br><span class="line"></span><br><span class="line">    KSMC_NEW_CONTEXT(machineContext);</span><br><span class="line">    ksmc_getContextForThread(g_mainQueueThread, machineContext, false);</span><br><span class="line">    KSStackCursor stackCursor;</span><br><span class="line">    kssc_initWithMachineContext(&amp;stackCursor, KSSC_MAX_STACK_DEPTH, machineContext);</span><br><span class="line">    char eventID[37];</span><br><span class="line">    ksid_generate(eventID);</span><br><span class="line"></span><br><span class="line">    KSLOG_DEBUG(@&quot;Filling out context.&quot;);</span><br><span class="line">    KSCrash_MonitorContext* crashContext &#x3D; &amp;g_monitorContext;</span><br><span class="line">    memset(crashContext, 0, sizeof(*crashContext));</span><br><span class="line">    crashContext-&gt;crashType &#x3D; KSCrashMonitorTypeMainThreadDeadlock;</span><br><span class="line">    crashContext-&gt;eventID &#x3D; eventID;</span><br><span class="line">    crashContext-&gt;registersAreValid &#x3D; false;</span><br><span class="line">    crashContext-&gt;offendingMachineContext &#x3D; machineContext;</span><br><span class="line">    crashContext-&gt;stackCursor &#x3D; &amp;stackCursor;</span><br><span class="line">    </span><br><span class="line">    kscm_handleException(crashContext);</span><br><span class="line">    ksmc_resumeEnvironment(threads, numThreads);</span><br><span class="line"></span><br><span class="line">    KSLOG_DEBUG(@&quot;Calling abort()&quot;);</span><br><span class="line">    abort();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://393698063.github.io/2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-5-Dead-lock/" data-id="claw83fqd0004ab9j9xxvczg0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-KSCrash-源码阅读-5-C-Exception" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-5-C-Exception/" class="article-date">
  <time datetime="2022-04-11T11:44:49.000Z" itemprop="datePublished">2022-04-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-5-C-Exception/">KSCrash-源码阅读-5 C++ Exception</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="异常监听"><a href="#异常监听" class="headerlink" title="异常监听"></a>异常监听</h2><p>c++ 异常处理的实现是依靠了标准库的 std::set_terminate(CPPExceptionTerminate) 函数。</p>
<p>iOS 工程中某些功能的实现可能使用了C、C++等。假如抛出 C++ 异常，如果该异常可以被转换为 NSException，则走 OC 异常捕获机制，如果不能转换，则继续走 C++ 异常流程，也就是 default_terminate_handler。这个 C++ 异常的默认 terminate 函数内部调用 abort_message 函数，最后触发了一个 abort 调用，系统产生一个 SIGABRT 信号。</p>
<p>在系统抛出 C++ 异常后，加一层 try…catch… 来判断该异常是否可以转换为 NSException，再重新抛出的C++异常。此时异常的现场堆栈已经消失，所以上层通过捕获 SIGABRT 信号是无法还原发生异常时的场景，即异常堆栈缺失。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">static void setEnabled(bool isEnabled)</span><br><span class="line">&#123;</span><br><span class="line">    if(isEnabled !&#x3D; g_isEnabled)</span><br><span class="line">    &#123;</span><br><span class="line">        g_isEnabled &#x3D; isEnabled;</span><br><span class="line">        if(isEnabled)</span><br><span class="line">        &#123;</span><br><span class="line">            initialize();</span><br><span class="line"></span><br><span class="line">            ksid_generate(g_eventID);</span><br><span class="line">            g_originalTerminateHandler &#x3D; std::set_terminate(CPPExceptionTerminate);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            std::set_terminate(g_originalTerminateHandler);</span><br><span class="line">        &#125;</span><br><span class="line">        g_captureNextStackTrace &#x3D; isEnabled;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">static void initialize()</span><br><span class="line">&#123;</span><br><span class="line">    static bool isInitialized &#x3D; false;</span><br><span class="line">    if(!isInitialized)</span><br><span class="line">    &#123;</span><br><span class="line">        isInitialized &#x3D; true;</span><br><span class="line">        kssc_initCursor(&amp;g_stackCursor, NULL, NULL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">void kssc_initCursor(KSStackCursor *cursor,</span><br><span class="line">                     void (*resetCursor)(KSStackCursor*),</span><br><span class="line">                     bool (*advanceCursor)(KSStackCursor*))</span><br><span class="line">&#123;</span><br><span class="line">    cursor-&gt;symbolicate &#x3D; kssymbolicator_symbolicate;</span><br><span class="line">    cursor-&gt;advanceCursor &#x3D; advanceCursor !&#x3D; NULL ? advanceCursor : g_advanceCursor;</span><br><span class="line">    cursor-&gt;resetCursor &#x3D; resetCursor !&#x3D; NULL ? resetCursor : kssc_resetCursor;</span><br><span class="line">    cursor-&gt;resetCursor(cursor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="处理异常"><a href="#处理异常" class="headerlink" title="处理异常"></a>处理异常</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">static void CPPExceptionTerminate(void)</span><br><span class="line">&#123;</span><br><span class="line">    thread_act_array_t threads &#x3D; NULL;</span><br><span class="line">    mach_msg_type_number_t numThreads &#x3D; 0;</span><br><span class="line">    ksmc_suspendEnvironment(&amp;threads, &amp;numThreads);</span><br><span class="line">    KSLOG_DEBUG(&quot;Trapped c++ exception&quot;);</span><br><span class="line">    const char* name &#x3D; NULL;</span><br><span class="line">    std::type_info* tinfo &#x3D; __cxxabiv1::__cxa_current_exception_type();</span><br><span class="line">    if(tinfo !&#x3D; NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        name &#x3D; tinfo-&gt;name();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if(name &#x3D;&#x3D; NULL || strcmp(name, &quot;NSException&quot;) !&#x3D; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        kscm_notifyFatalExceptionCaptured(false);</span><br><span class="line">        KSCrash_MonitorContext* crashContext &#x3D; &amp;g_monitorContext;</span><br><span class="line">        memset(crashContext, 0, sizeof(*crashContext));</span><br><span class="line"></span><br><span class="line">        char descriptionBuff[DESCRIPTION_BUFFER_LENGTH];</span><br><span class="line">        const char* description &#x3D; descriptionBuff;</span><br><span class="line">        descriptionBuff[0] &#x3D; 0;</span><br><span class="line"></span><br><span class="line">        KSLOG_DEBUG(&quot;Discovering what kind of exception was thrown.&quot;);</span><br><span class="line">        g_captureNextStackTrace &#x3D; false;</span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line">            throw;</span><br><span class="line">        &#125;</span><br><span class="line">        catch(std::exception&amp; exc)</span><br><span class="line">        &#123;</span><br><span class="line">            strncpy(descriptionBuff, exc.what(), sizeof(descriptionBuff));</span><br><span class="line">        &#125;</span><br><span class="line">#define CATCH_VALUE(TYPE, PRINTFTYPE) \</span><br><span class="line">catch(TYPE value)\</span><br><span class="line">&#123; \</span><br><span class="line">    snprintf(descriptionBuff, sizeof(descriptionBuff), &quot;%&quot; #PRINTFTYPE, value); \</span><br><span class="line">&#125;</span><br><span class="line">        CATCH_VALUE(char,                 d)</span><br><span class="line">        CATCH_VALUE(short,                d)</span><br><span class="line">        CATCH_VALUE(int,                  d)</span><br><span class="line">        CATCH_VALUE(long,                ld)</span><br><span class="line">        CATCH_VALUE(long long,          lld)</span><br><span class="line">        CATCH_VALUE(unsigned char,        u)</span><br><span class="line">        CATCH_VALUE(unsigned short,       u)</span><br><span class="line">        CATCH_VALUE(unsigned int,         u)</span><br><span class="line">        CATCH_VALUE(unsigned long,       lu)</span><br><span class="line">        CATCH_VALUE(unsigned long long, llu)</span><br><span class="line">        CATCH_VALUE(float,                f)</span><br><span class="line">        CATCH_VALUE(double,               f)</span><br><span class="line">        CATCH_VALUE(long double,         Lf)</span><br><span class="line">        CATCH_VALUE(char*,                s)</span><br><span class="line">        catch(...)</span><br><span class="line">        &#123;</span><br><span class="line">            description &#x3D; NULL;</span><br><span class="line">        &#125;</span><br><span class="line">        g_captureNextStackTrace &#x3D; g_isEnabled;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; TODO: Should this be done here? Maybe better in the exception handler?</span><br><span class="line">        KSMC_NEW_CONTEXT(machineContext);</span><br><span class="line">        ksmc_getContextForThread(ksthread_self(), machineContext, true);</span><br><span class="line"></span><br><span class="line">        KSLOG_DEBUG(&quot;Filling out context.&quot;);</span><br><span class="line">        crashContext-&gt;crashType &#x3D; KSCrashMonitorTypeCPPException;</span><br><span class="line">        crashContext-&gt;eventID &#x3D; g_eventID;</span><br><span class="line">        crashContext-&gt;registersAreValid &#x3D; false;</span><br><span class="line">        crashContext-&gt;stackCursor &#x3D; &amp;g_stackCursor;</span><br><span class="line">        crashContext-&gt;CPPException.name &#x3D; name;</span><br><span class="line">        crashContext-&gt;exceptionName &#x3D; name;</span><br><span class="line">        crashContext-&gt;crashReason &#x3D; description;</span><br><span class="line">        crashContext-&gt;offendingMachineContext &#x3D; machineContext;</span><br><span class="line"></span><br><span class="line">        kscm_handleException(crashContext);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        KSLOG_DEBUG(&quot;Detected NSException. Letting the current NSException handler deal with it.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    ksmc_resumeEnvironment(threads, numThreads);</span><br><span class="line"></span><br><span class="line">    KSLOG_DEBUG(&quot;Calling original terminate handler.&quot;);</span><br><span class="line">    g_originalTerminateHandler();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://393698063.github.io/2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-5-C-Exception/" data-id="claw83fqf0007ab9jcdwqdkff" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-KSCrash-源码阅读-4-NSEexption" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-4-NSEexption/" class="article-date">
  <time datetime="2022-04-11T02:49:33.000Z" itemprop="datePublished">2022-04-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-4-NSEexption/">KSCrash-源码阅读-4 NSEexption</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="添加NsException-自定义处理入口"><a href="#添加NsException-自定义处理入口" class="headerlink" title="添加NsException 自定义处理入口"></a>添加NsException 自定义处理入口</h2><ol>
<li>NSGetUncaughtExceptionHandler() 获取已经添加的处理入口</li>
<li>NSSetUncaughtExceptionHandler(&amp;handleUncaughtException) 添加自己的异常处理入口<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">static void setEnabled(bool isEnabled)</span><br><span class="line">&#123;</span><br><span class="line">    if(isEnabled !&#x3D; g_isEnabled)</span><br><span class="line">    &#123;</span><br><span class="line">        g_isEnabled &#x3D; isEnabled;</span><br><span class="line">        if(isEnabled)</span><br><span class="line">        &#123;</span><br><span class="line">            KSLOG_DEBUG(@&quot;Backing up original handler.&quot;);</span><br><span class="line">            g_previousUncaughtExceptionHandler &#x3D; NSGetUncaughtExceptionHandler();</span><br><span class="line">            </span><br><span class="line">            KSLOG_DEBUG(@&quot;Setting new handler.&quot;);</span><br><span class="line">            NSSetUncaughtExceptionHandler(&amp;handleUncaughtException);</span><br><span class="line">            KSCrash.sharedInstance.uncaughtExceptionHandler &#x3D; &amp;handleUncaughtException;</span><br><span class="line">            KSCrash.sharedInstance.currentSnapshotUserReportedExceptionHandler &#x3D; &amp;handleCurrentSnapshotUserReportedException;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            KSLOG_DEBUG(@&quot;Restoring original handler.&quot;);</span><br><span class="line">            NSSetUncaughtExceptionHandler(g_previousUncaughtExceptionHandler);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="异常处理入口"><a href="#异常处理入口" class="headerlink" title="异常处理入口"></a>异常处理入口</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">&#x2F;** Our custom excepetion handler.</span><br><span class="line"> * Fetch the stack trace from the exception and write a report.</span><br><span class="line"> *</span><br><span class="line"> * @param exception The exception that was raised.</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">static void handleException(NSException* exception, BOOL currentSnapshotUserReported) &#123;</span><br><span class="line">    KSLOG_DEBUG(@&quot;Trapped exception %@&quot;, exception);</span><br><span class="line">    if(g_isEnabled)</span><br><span class="line">    &#123;</span><br><span class="line">        thread_act_array_t threads &#x3D; NULL;</span><br><span class="line">        mach_msg_type_number_t numThreads &#x3D; 0;</span><br><span class="line">        ksmc_suspendEnvironment(&amp;threads, &amp;numThreads);</span><br><span class="line">        kscm_notifyFatalExceptionCaptured(false);</span><br><span class="line"></span><br><span class="line">        KSLOG_DEBUG(@&quot;Filling out context.&quot;);</span><br><span class="line">        NSArray* addresses &#x3D; [exception callStackReturnAddresses];</span><br><span class="line">        NSUInteger numFrames &#x3D; addresses.count;</span><br><span class="line">        uintptr_t* callstack &#x3D; malloc(numFrames * sizeof(*callstack));</span><br><span class="line">        for(NSUInteger i &#x3D; 0; i &lt; numFrames; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            callstack[i] &#x3D; (uintptr_t)[addresses[i] unsignedLongLongValue];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        char eventID[37];</span><br><span class="line">        ksid_generate(eventID);</span><br><span class="line">        KSMC_NEW_CONTEXT(machineContext);</span><br><span class="line">        ksmc_getContextForThread(ksthread_self(), machineContext, true);</span><br><span class="line">        KSStackCursor cursor;</span><br><span class="line">        kssc_initWithBacktrace(&amp;cursor, callstack, (int)numFrames, 0);</span><br><span class="line"></span><br><span class="line">        KSCrash_MonitorContext* crashContext &#x3D; &amp;g_monitorContext;</span><br><span class="line">        memset(crashContext, 0, sizeof(*crashContext));</span><br><span class="line">        crashContext-&gt;crashType &#x3D; KSCrashMonitorTypeNSException;</span><br><span class="line">        crashContext-&gt;eventID &#x3D; eventID;</span><br><span class="line">        crashContext-&gt;offendingMachineContext &#x3D; machineContext;</span><br><span class="line">        crashContext-&gt;registersAreValid &#x3D; false;</span><br><span class="line">        crashContext-&gt;NSException.name &#x3D; [[exception name] UTF8String];</span><br><span class="line">        crashContext-&gt;NSException.userInfo &#x3D; [[NSString stringWithFormat:@&quot;%@&quot;, exception.userInfo] UTF8String];</span><br><span class="line">        crashContext-&gt;exceptionName &#x3D; crashContext-&gt;NSException.name;</span><br><span class="line">        crashContext-&gt;crashReason &#x3D; [[exception reason] UTF8String];</span><br><span class="line">        crashContext-&gt;stackCursor &#x3D; &amp;cursor;</span><br><span class="line">        crashContext-&gt;currentSnapshotUserReported &#x3D; currentSnapshotUserReported;</span><br><span class="line"></span><br><span class="line">        KSLOG_DEBUG(@&quot;Calling main crash handler.&quot;);</span><br><span class="line">        kscm_handleException(crashContext);</span><br><span class="line"></span><br><span class="line">        free(callstack);</span><br><span class="line">        if (currentSnapshotUserReported) &#123;</span><br><span class="line">            ksmc_resumeEnvironment(threads, numThreads);</span><br><span class="line">        &#125;</span><br><span class="line">        if (g_previousUncaughtExceptionHandler !&#x3D; NULL)</span><br><span class="line">        &#123;</span><br><span class="line">            KSLOG_DEBUG(@&quot;Calling original exception handler.&quot;);</span><br><span class="line">            g_previousUncaughtExceptionHandler(exception);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://393698063.github.io/2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-4-NSEexption/" data-id="claw83fqb0003ab9jf1yh2981" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-KSCrash-源码阅读-3-Signal" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-3-Signal/" class="article-date">
  <time datetime="2022-04-11T01:53:15.000Z" itemprop="datePublished">2022-04-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-3-Signal/">KSCrash-源码阅读-3 Signal</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Signal异常处理流程"><a href="#Signal异常处理流程" class="headerlink" title="Signal异常处理流程"></a>Signal异常处理流程</h2><ol>
<li>Restore the default signal handlers</li>
<li>添加signal handler 处理异常</li>
<li>record the signal information，write a crash report</li>
<li>Once we’re done, re-raise the signal and let the default handlers deal with it<h2 id="添加-signal-handler"><a href="#添加-signal-handler" class="headerlink" title="添加 signal handler"></a>添加 signal handler</h2></li>
<li>signal异常<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">定义在 #include &lt;machine&#x2F;signal.h&gt; </span><br><span class="line">    SIGABRT,&#x2F;* abort() *&#x2F;</span><br><span class="line">    SIGBUS,&#x2F;* bus error *&#x2F;</span><br><span class="line">    SIGFPE,&#x2F;* floating point exception *&#x2F;</span><br><span class="line">    SIGILL,&#x2F;* illegal instruction (not reset when caught) *&#x2F;</span><br><span class="line">    SIGPIPE, &#x2F;* write on a pipe with no one to read it *&#x2F;</span><br><span class="line">    SIGSEGV, &#x2F;* segmentation violation *&#x2F;</span><br><span class="line">    SIGSYS,&#x2F;* bad argument to system call *&#x2F;</span><br><span class="line">    SIGTRAP &#x2F;* trace trap (not reset when caught) *&#x2F;</span><br></pre></td></tr></table></figure></li>
<li>添加handler</li>
</ol>
<p>关键函数</p>
<blockquote>
<p>/**<br>一、函数原型：sigaction函数的功能是检查或修改与指定信号相关联的&gt; 处理动作（可同时&gt; 两种操作）</p>
<p>int sigaction(int signum, const struct sigaction *act,<br>                     struct sigaction *oldact);<br>signum参数指出要捕获的信号类型，act参数指定新的信号处理方式，&gt; &gt; oldact参数输出&gt; 先前信号的处理方式<br>                */</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">static bool installSignalHandler()</span><br><span class="line">&#123;</span><br><span class="line">    KSLOG_DEBUG(&quot;Installing signal handler.&quot;);</span><br><span class="line"></span><br><span class="line">#if KSCRASH_HAS_SIGNAL_STACK</span><br><span class="line"></span><br><span class="line">    if(g_signalStack.ss_size &#x3D;&#x3D; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        KSLOG_DEBUG(&quot;Allocating signal stack area.&quot;);</span><br><span class="line">        g_signalStack.ss_size &#x3D; SIGSTKSZ;</span><br><span class="line">        g_signalStack.ss_sp &#x3D; malloc(g_signalStack.ss_size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    KSLOG_DEBUG(&quot;Setting signal stack area.&quot;);</span><br><span class="line">     &#x2F;**</span><br><span class="line">     信号处理函数的栈挪到堆中，而不和进程共用一块栈区</span><br><span class="line">    sigaltstack() 函数，该函数的第 1 个参数 sigstack</span><br><span class="line">     是一个 stack_t 结构的指针，该结构存储了一个“可替换信号栈”</span><br><span class="line">     的位置及属性信息。第 2 个参数 old_sigstack</span><br><span class="line">     也是一个 stack_t 类型指针，</span><br><span class="line">     它用来返回上一次建立的“可替换信号栈”的信息(如果有的话)</span><br><span class="line">     *&#x2F;</span><br><span class="line">    if(sigaltstack(&amp;g_signalStack, NULL) !&#x3D; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        KSLOG_ERROR(&quot;signalstack: %s&quot;, strerror(errno));</span><br><span class="line">        goto failed;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    const int* fatalSignals &#x3D; kssignal_fatalSignals();</span><br><span class="line">    int fatalSignalsCount &#x3D; kssignal_numFatalSignals();</span><br><span class="line"></span><br><span class="line">    if(g_previousSignalHandlers &#x3D;&#x3D; NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        KSLOG_DEBUG(&quot;Allocating memory to store previous signal handlers.&quot;);</span><br><span class="line">        g_previousSignalHandlers &#x3D; malloc(sizeof(*g_previousSignalHandlers)</span><br><span class="line">                                          * (unsigned)fatalSignalsCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    struct sigaction action &#x3D; &#123;&#123;0&#125;&#125;;</span><br><span class="line">    action.sa_flags &#x3D; SA_SIGINFO | SA_ONSTACK;</span><br><span class="line">#if KSCRASH_HOST_APPLE &amp;&amp; defined(__LP64__)</span><br><span class="line">    action.sa_flags |&#x3D; SA_64REGSET;</span><br><span class="line">#endif</span><br><span class="line">    sigemptyset(&amp;action.sa_mask);</span><br><span class="line">    action.sa_sigaction &#x3D; &amp;handleSignal;</span><br><span class="line"></span><br><span class="line">    for(int i &#x3D; 0; i &lt; fatalSignalsCount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        KSLOG_DEBUG(&quot;Assigning handler for signal %d&quot;, fatalSignals[i]);</span><br><span class="line">        if(sigaction(fatalSignals[i], &amp;action, &amp;g_previousSignalHandlers[i]) !&#x3D; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            char sigNameBuff[30];</span><br><span class="line">            const char* sigName &#x3D; kssignal_signalName(fatalSignals[i]);</span><br><span class="line">            if(sigName &#x3D;&#x3D; NULL)</span><br><span class="line">            &#123;</span><br><span class="line">                snprintf(sigNameBuff, sizeof(sigNameBuff), &quot;%d&quot;, fatalSignals[i]);</span><br><span class="line">                sigName &#x3D; sigNameBuff;</span><br><span class="line">            &#125;</span><br><span class="line">            KSLOG_ERROR(&quot;sigaction (%s): %s&quot;, sigName, strerror(errno));</span><br><span class="line">            &#x2F;&#x2F; Try to reverse the damage</span><br><span class="line">            for(i--;i &gt;&#x3D; 0; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                &#x2F;**</span><br><span class="line">                 一、函数原型：sigaction函数的功能是检查或修改与指定信号相关联的处理动作（可同时两种操作）</span><br><span class="line"></span><br><span class="line">                 int sigaction(int signum, const struct sigaction *act,</span><br><span class="line">                                      struct sigaction *oldact);</span><br><span class="line">                 signum参数指出要捕获的信号类型，act参数指定新的信号处理方式，oldact参数输出先前信号的处理方式</span><br><span class="line">                 *&#x2F;</span><br><span class="line">                sigaction(fatalSignals[i], &amp;g_previousSignalHandlers[i], NULL);</span><br><span class="line">            &#125;</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    KSLOG_DEBUG(&quot;Signal handlers installed.&quot;);</span><br><span class="line">    return true;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line">    KSLOG_DEBUG(&quot;Failed to install signal handlers.&quot;);</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="处理异常"><a href="#处理异常" class="headerlink" title="处理异常"></a>处理异常</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** Our custom signal handler.</span><br><span class="line"> * Restore the default signal handlers, record the signal information, and</span><br><span class="line"> * write a crash report.</span><br><span class="line"> * Once we&#39;re done, re-raise the signal and let the default handlers deal with</span><br><span class="line"> * it.</span><br><span class="line"> *</span><br><span class="line"> * @param sigNum The signal that was raised.</span><br><span class="line"> *</span><br><span class="line"> * @param signalInfo Information about the signal.</span><br><span class="line"> *</span><br><span class="line"> * @param userContext Other contextual information.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static void handleSignal(int sigNum, siginfo_t* signalInfo, void* userContext)</span><br><span class="line">&#123;</span><br><span class="line">    KSLOG_DEBUG(&quot;Trapped signal %d&quot;, sigNum);</span><br><span class="line">    if(g_isEnabled)</span><br><span class="line">    &#123;</span><br><span class="line">        thread_act_array_t threads &#x3D; NULL;</span><br><span class="line">        mach_msg_type_number_t numThreads &#x3D; 0;</span><br><span class="line">        ksmc_suspendEnvironment(&amp;threads, &amp;numThreads);</span><br><span class="line">        kscm_notifyFatalExceptionCaptured(false);</span><br><span class="line"></span><br><span class="line">        KSLOG_DEBUG(&quot;Filling out context.&quot;);</span><br><span class="line">        KSMC_NEW_CONTEXT(machineContext);</span><br><span class="line">        ksmc_getContextForSignal(userContext, machineContext);</span><br><span class="line">        kssc_initWithMachineContext(&amp;g_stackCursor, KSSC_MAX_STACK_DEPTH, machineContext);</span><br><span class="line"></span><br><span class="line">        KSCrash_MonitorContext* crashContext &#x3D; &amp;g_monitorContext;</span><br><span class="line">        memset(crashContext, 0, sizeof(*crashContext));</span><br><span class="line">        crashContext-&gt;crashType &#x3D; KSCrashMonitorTypeSignal;</span><br><span class="line">        crashContext-&gt;eventID &#x3D; g_eventID;</span><br><span class="line">        crashContext-&gt;offendingMachineContext &#x3D; machineContext;</span><br><span class="line">        crashContext-&gt;registersAreValid &#x3D; true;</span><br><span class="line">        crashContext-&gt;faultAddress &#x3D; (uintptr_t)signalInfo-&gt;si_addr;</span><br><span class="line">        crashContext-&gt;signal.userContext &#x3D; userContext;</span><br><span class="line">        crashContext-&gt;signal.signum &#x3D; signalInfo-&gt;si_signo;</span><br><span class="line">        crashContext-&gt;signal.sigcode &#x3D; signalInfo-&gt;si_code;</span><br><span class="line">        crashContext-&gt;stackCursor &#x3D; &amp;g_stackCursor;</span><br><span class="line"></span><br><span class="line">        kscm_handleException(crashContext);</span><br><span class="line">        ksmc_resumeEnvironment(threads, numThreads);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    KSLOG_DEBUG(&quot;Re-raising signal for regular handlers to catch.&quot;);</span><br><span class="line">    &#x2F;&#x2F; This is technically not allowed, but it works in OSX and iOS.</span><br><span class="line">    raise(sigNum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调试signal"><a href="#调试signal" class="headerlink" title="调试signal"></a>调试signal</h2><p>Xcode Debug模式运行App时，App进程signal被LLDB Debugger调试器捕获；需要使用LLDB调试命令，将指定signal处理抛到用户层处理，方便调试。</p>
<p>查看全部信号传递配置：<br><br>// process handle缩写 <br><br>pro hand <br><br>修改指定信号传递配置：<br><br>// option: <br><br>//   -P: PASS <br><br>//   -S: STOP <br><br>//   -N: NOTIFY<br><br>pro hand -option false 信号名<br></p>
<p>// 例：SIGABRT信号处理在LLDB不停止，可继续抛到用户层<br><br>pro hand -s false SIGABRT<br></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://393698063.github.io/2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-3-Signal/" data-id="claw83fqa0002ab9j7e0z3ppx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-卡顿说明" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="2022/01/24/%E5%8D%A1%E9%A1%BF%E8%AF%B4%E6%98%8E/" class="article-date">
  <time datetime="2022-01-24T06:58:08.000Z" itemprop="datePublished">2022-01-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="2022/01/24/%E5%8D%A1%E9%A1%BF%E8%AF%B4%E6%98%8E/">卡顿说明</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://perfdog.qq.com/article_detail?id=10162&issue_id=0&plat_id=1" target="_blank" rel="noopener">参考</a></p>
<h2 id="第一部分：FrameTime"><a href="#第一部分：FrameTime" class="headerlink" title="第一部分：FrameTime"></a>第一部分：FrameTime</h2><pre><code>FrameTime 的定义：两帧画面间隔耗时(也可简单认为单帧渲染耗时)。

对于FrameTime和卡顿是否有关联？请看下图的案例图示：
{% asset_img 8f45de6b-60de-4021-80a3-be3d2cbd3ea9.png This is an example image %}</code></pre><p> 从图中可看出画面中B帧在GPU渲染耗时(帧生成时间)大于显示器刷新间隔,占用两次显示器刷新耗时。也就是说有一次画面没刷新。当出现多次没有画面刷新(也就是说画面没变化)，则可能是一次卡顿。</p>
<p>从这里就得出结论：玩家用户真正看到的是屏幕新画面刷新间隔时间，而不是eglSwapbuffers-GPU渲染完成(并未有提交屏幕显示)间隔时间。所以后面所提到Frametime统统指的是屏幕Display-Frametime。</p>
<p>PerfDog工具优点：PerfDog统计的FPS和Frametime都是用户看到的屏幕Display新画面真实刷新FPS和帧耗时。所以大家可以直接通过Frametime来判断测试过程中是否出现卡顿</p>
<h2 id="第二部分：FPS"><a href="#第二部分：FPS" class="headerlink" title="第二部分：FPS"></a>第二部分：FPS</h2><pre><code>FPS的定义：帧率（1秒内平均画面刷新次数）。

平均帧率:传统常说的FPS，1秒内平均画面刷新次数。

瞬时帧率:单帧耗时FrameTime算出来实时FPS，每一帧画面刷新耗时换算出的实时帧率。



画面渲染流程图如下，每一帧FrameTime。
 {% asset_img 24bfdf7a-4db8-4d64-a324-3731a28d5ee1.png This is an example image %}</code></pre><p>PerfDog统计帧率及FrameTime如下图：<br> <img src="2022/01/24/%E5%8D%A1%E9%A1%BF%E8%AF%B4%E6%98%8E/7c11a66c-a456-43a4-b8a8-29b4f964794b.png" class="" title="This is an example image"></p>
<p>  iOS端<br>        苹果WDDC18年开发者大会</p>
<pre><code>①     FramePacing

比如下面两个游戏画面,左边的试图以60帧运行,但实际只能达到40帧;右边的则持续稳定在30帧运行:
 {% asset_img 640.gif This is an example image %}</code></pre><p>通过FrameTime可以看出，左边高帧率FPS=40帧率中出现一次FrameTim&gt;=117ms，理论平均FrameTime=25ms。所以非均匀渲染，虽然帧率高达40，但依然觉得非常卡。</p>
<p>总结：帧率高，未必流畅</p>
<h2 id="第三部分：流畅度"><a href="#第三部分：流畅度" class="headerlink" title="第三部分：流畅度"></a>第三部分：流畅度</h2><pre><code>流畅度与卡顿的关联可以用以下的流程图来大致展示：</code></pre>{% asset_img 76c17c01-f03d-488a-8929-b399351f51d8.png This is an example image %}
<pre><code>流畅度影响卡顿。这个可以简单的理解为视觉惯性和电影帧这两个方面

 1、视觉惯性
    视觉预期帧率，用户潜意识里认为下帧也应该是当前帧率刷新比如一直60帧，用户潜意识里认为下帧也应该是60帧率。刷新一直是25帧，用户潜意识里认为下帧也应该是25帧率。但是刷新如果是60帧一下跳变为25帧，扰乱用户视觉惯性。这个时候就会出现用户体验的卡顿感。



2、电影帧
    电影帧率(18-24)，一般是24帧。电影帧单帧耗时：1000ms/24≈41.67ms。电影帧率是一个临界点。低于这个帧率，人眼基本能感觉画面不连续性，也就是感觉到了卡顿。</code></pre><h2 id="第四部分："><a href="#第四部分：" class="headerlink" title="第四部分："></a>第四部分：</h2><ul>
<li>Color Blended Layers - 这个选项基于渲染程度对屏幕中的混合区域进行绿到 红的高亮(也就是多个半透明图层的叠加)。由于重绘的原因，混合对GPU性 能会有影响，同时也是滑动或者动画帧率下降的罪魁祸首之一。</li>
<li>Color Hits Green and Misses Red - 当使用 shouldRasterizep 属性的时候， 耗时的图层绘制会被缓存，然后当做一个简单的扁平图片呈现。当缓存再生的时候这个选项就用红色对栅格化图层进行了高亮。如果缓存频繁再生的话，就意味着栅格化可能会有负面的性能影响了。</li>
<li>Color Copied Images - 有时候寄宿图片的生成意味着Core Animation被强制生成一些图片，然后发送到渲染服务器，而不是简单的指向原始指针。这个选 项把这些图片渲染成蓝色。复制图片对内存和CPU使用来说都是一项非常昂贵的操作，所以应该尽可能的避免。</li>
<li>Color Immediately - 通常Core Animation Instruments以每毫秒10次的频率更 新图层调试颜色。对某些效果来说，这显然太慢了。这个选项就可以用来设置每帧都更新(可能会影响到渲染性能，而且会导致帧率测量不准，所以不要一直都设置它)。</li>
<li>Color Misaligned Images - 这里会高亮那些被缩放或者拉伸以及没有正确对齐到像素边界的图片(也就是非整型坐标)。这些中的大多数通常都会导致图片的不正常缩放，如果把一张大图当缩略图显示，或者不正确地模糊图像，那么这个选项将会帮你识别出问题所在。</li>
<li>Color Offscreen-Rendered Yellow - 这里会把那些需要离屏渲染的图层高亮 成黄色。这些图层很可能需要用 shadowPath 或者 shouldRasterize 来优化。</li>
<li>Color OpenGL Fast Path Blue - 这个选项会对任何直接使用OpenGL绘制的 图层进行高亮。如果仅仅使用UIKit或者Core Animation的API，那么不会有任何效果。如果使用 GLKView 或者 CAEAGLLayer，那如果不显示蓝色块的话就意味着你正在强制CPU渲染额外的纹理，而不是绘制到屏幕。</li>
<li>Flash Updated Regions - 这个选项会对重绘的内容高亮成黄色(也就是任何在软件层面使用Core Graphics绘制的图层)。这种绘图的速度很慢。如果频繁发生这种情况的话，这意味着有一个隐藏的bug或者说通过增加缓存或者使 用替代方案会有提升性能的空间。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://393698063.github.io/2022/01/24/%E5%8D%A1%E9%A1%BF%E8%AF%B4%E6%98%8E/" data-id="claw83fqj000aab9jc4egagis" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-KSCrash-源码阅读-1-Crash分类" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="2021/12/29/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-1-Crash%E5%88%86%E7%B1%BB/" class="article-date">
  <time datetime="2021-12-29T12:03:55.000Z" itemprop="datePublished">2021-12-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="2021/12/29/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-1-Crash%E5%88%86%E7%B1%BB/">KSCrash 源码阅读(1) Crash分类</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-异常的类型"><a href="#1-异常的类型" class="headerlink" title="1. 异常的类型"></a>1. 异常的类型</h2><ul>
<li><p>Mach kernel exception：是指最底层的内核级异常。用户态?的开发者可以直接通过Mach API设置thread，task，host?的异常端口，来捕获Mach异常</p>
</li>
<li><p>Fatal signal：又称 BSD? 信号，如果开发者没有捕获Mach异常，则会被host层的方法ux_exception()将异常转换为对应的UNIX信号，并通过方法threadsignal()将信号投递到出错线程。可以通过方法signal(x, SignalHandler)来捕获signal</p>
</li>
<li><p>Uncaught C++ exception ： Captures and reports C++ exceptions</p>
</li>
<li><p>Uncaught Objective-C NSException ：应用级异常，它是未被捕获的Objective-C异常，导致程序向自身发送了SIGABRT信号而崩溃，是app自己可控的，对于未捕获的Objective-C异常，是可以通过try catch来捕获的，或者通过NSSetUncaughtExceptionHandler()机制来捕获</p>
</li>
<li><p>Deadlock on the main thread：</p>
</li>
<li><p>User reported custom exception ：</p>
<h2 id="2-Mach异常与-Unix-信号"><a href="#2-Mach异常与-Unix-信号" class="headerlink" title="2. Mach异常与 Unix 信号"></a>2. Mach异常与 Unix 信号</h2><blockquote>
<ul>
<li>Mach是一个微内核，旨在提供基本的进程间通信功能。</li>
<li>XNU是一个混合内核，由Mach微内核和更传统（“单片”）</li>
<li>BSD unix内核的组件组成。它还包括在运行时加载内核扩展的功能（添加功能，设备驱动程序等）</li>
<li>Darwin是一个Unix操作系统，由XNU内核以及各种开源实用程序，库等组成。<br>OS X是Darwin，加上许多专有组件，最着名的是它的图形界面API。</li>
</ul>
</blockquote>
<ol>
<li>Mach微内核中有几个基础概念：</li>
</ol>
</li>
</ul>
<ul>
<li>Tasks，拥有一组系统资源的对象，允许”thread”在其中执行。</li>
<li>Threads，执行的基本单位，拥有task的上下文，并共享其资源。</li>
<li>Ports，task之间通讯的一组受保护的消息队列；task可对任何port发送/接收数据。</li>
<li>Message，有类型的数据对象集合，只可以发送到port</li>
</ul>
<ol start="2">
<li><p>signal：<br>1) SIGHUP<br>本信号在用户终端连接(正常或非正常)结束时发出, 通常是在终端的控制进程结束时, 通知同一session内的各个作业, 这时它们与控制终端不再关联。<br>登录Linux时，系统会分配给登录用户一个终端(Session)。在这个终端运行的所有程序，包括前台进程组和后台进程组，一般都属于这个 Session。当用户退出Linux登录时，前台进程组和后台有对终端输出的进程将会收到SIGHUP信号。这个信号的默认操作为终止进程，因此前台进 程组和后台有终端输出的进程就会中止。不过可以捕获这个信号，比如wget能捕获SIGHUP信号，并忽略它，这样就算退出了Linux登录， wget也 能继续下载。<br>此外，对于与终端脱离关系的守护进程，这个信号用于通知它重新读取配置文件。<br>2) SIGINT<br>程序终止(interrupt)信号, 在用户键入INTR字符(通常是Ctrl-C)时发出，用于通知前台进程组终止进程。<br>3) SIGQUIT<br>和SIGINT类似, 但由QUIT字符(通常是Ctrl-)来控制. 进程在因收到SIGQUIT退出时会产生core文件, 在这个意义上类似于一个程序错误信号。<br>6) SIGABRT<br>调用abort函数生成的信号。<br>7) SIGBUS<br>非法地址, 包括内存地址对齐(alignment)出错。比如访问一个四个字长的整数, 但其地址不是4的倍数。它与SIGSEGV的区别在于后者是由于对合法存储地址的非法访问触发的(如访问不属于自己存储空间或只读存储空间)。<br>8) SIGFPE<br>在发生致命的算术运算错误时发出. 不仅包括浮点运算错误, 还包括溢出及除数为0等其它所有的算术的错误。<br>9) SIGKILL<br>用来立即结束程序的运行. 本信号不能被阻塞、处理和忽略。如果管理员发现某个进程终止不了，可尝试发送这个信号。<br>11) SIGSEGV<br>试图访问未分配给自己的内存, 或试图往没有写权限的内存地址写数据.<br>13) SIGPIPE<br>管道破裂。这个信号通常在进程间通信产生，比如采用FIFO(管道)通信的两个进程，读管道没打开或者意外终止就往管道写，写进程会收到SIGPIPE信号。此外用Socket通信的两个进程，写进程在写Socket的时候，读进程已经终止。<br>ios crash 中主要是SIGKILL,SIGSEGV,SIGABRT,SIGTRAP<br>引起系统信号crash 主要有内存泄露、野指针等.<br>几种特别类型:<br>0x8badf00d 在启动、终⽌止应⽤用或响应系统事件花费过⻓长时间,意为“ate bad food”。<br>0xdeadfa11 ⽤用户强制退出,意为“dead fall”。(系统⽆无响应时,⽤用户按电源开关和HOME)<br>0xbaaaaaad ⽤用户按住Home键和⾳音量键,获取当前内存状态,不代表崩溃<br>0xbad22222 VoIP应⽤用因为恢复得太频繁导致crash<br>0xc00010ff 因为太烫了被干掉,意为“cool off”<br>0xdead10cc 因为在后台时仍然占据系统资源(⽐比如通讯录)被干掉,意为“dead lock”</p>
<h2 id="3-Objective-C-Exception"><a href="#3-Objective-C-Exception" class="headerlink" title="3. Objective-C Exception"></a>3. Objective-C Exception</h2><p>比如我们经常遇到的数组越界，数组插入 nil，都是属于此种类型，主要包含以下几类：</p>
</li>
</ol>
<ul>
<li><p>NSInvalidArgumentException<br>非法参数异常</p>
</li>
<li><p>NSRangeException<br>数组越界异常</p>
</li>
<li><p>NSGenericException<br>这个异常最容易出现在foreach操作中，在for in循环中如果修改所遍历的数组，无论你是add或remove，都会出错</p>
</li>
<li><p>NSInternalInconsistencyException<br>不一致导致出现的异常<br>比如NSDictionary当做NSMutableDictionary来使用，从他们内部的机理来说，就会产生一些错误</p>
</li>
<li><p>NSFileHandleOperationException<br>处理文件时的一些异常，最常见的还是存储空间不足的问题</p>
</li>
<li><p>NSMallocException<br>这也是内存不足的问题，无法分配足够的内存空间</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://393698063.github.io/2021/12/29/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-1-Crash%E5%88%86%E7%B1%BB/" data-id="claw83fq80001ab9j1x4ifavq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-KSCrash-源码阅读-2 Mach kerner execption" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="2021/12/29/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-2%20Mach%20kerner%20execption/" class="article-date">
  <time datetime="2021-12-29T11:02:57.000Z" itemprop="datePublished">2021-12-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="2021/12/29/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-2%20Mach%20kerner%20execption/">KSCrash 源码阅读-2 Mach kerner exception</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="mach-crash-处理流程"><a href="#mach-crash-处理流程" class="headerlink" title="mach crash 处理流程"></a>mach crash 处理流程</h2><p><img src="./KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-2%20Mach%20kerner%20execption/mach_crash_flow.png" alt="h5 load time"></p>
<img src="2021/12/29/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-2%20Mach%20kerner%20execption/mach_crash_flow.png" class="" title="This is an example image">
<h2 id="1-注册mach异常处理回调"><a href="#1-注册mach异常处理回调" class="headerlink" title="1. 注册mach异常处理回调"></a>1. 注册mach异常处理回调</h2><ol>
<li>保存原先的端口，用来处理完后回调给原来的端口</li>
<li>mach_port_allocate 已receive rights新建一个端口</li>
<li>为新建端口添加发送消息权限</li>
<li>task_set_exception_ports 将新建端口作为异常接收端口</li>
<li>pthread_create创建一个备用线程</li>
<li>将备用线程将pthread_t的类型转换成mach_port_t类型</li>
<li>pthread_create 创建初始处理异常的线程<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">static bool installExceptionHandler()</span><br><span class="line">&#123;</span><br><span class="line">    KSLOG_DEBUG(&quot;Installing mach exception handler.&quot;);</span><br><span class="line"></span><br><span class="line">    bool attributes_created &#x3D; false;</span><br><span class="line">    pthread_attr_t attr;</span><br><span class="line"></span><br><span class="line">    kern_return_t kr;</span><br><span class="line">    int error;</span><br><span class="line">&#x2F;**</span><br><span class="line"> 任务（task）是一种容器（container）对象，</span><br><span class="line"> 虚拟内存空间和其他资源都是通过这个容器对象管理的，</span><br><span class="line"> 这些资源包括设备和其他句柄。资源进一步被抽象为端口。</span><br><span class="line"> 因而资源的共享实际上相当于允许对对应端口的访问</span><br><span class="line"></span><br><span class="line"> 链接：https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;cc655bfdac13</span><br><span class="line"> *&#x2F;</span><br><span class="line">    const task_t thisTask &#x3D; mach_task_self(); &#x2F;&#x2F;获得任务的端口，带有发送权限的名称</span><br><span class="line">    exception_mask_t mask &#x3D; EXC_MASK_BAD_ACCESS |</span><br><span class="line">    EXC_MASK_BAD_INSTRUCTION |</span><br><span class="line">    EXC_MASK_ARITHMETIC |</span><br><span class="line">    EXC_MASK_SOFTWARE |</span><br><span class="line">    EXC_MASK_BREAKPOINT;</span><br><span class="line">    &#x2F;&#x2F; 保存原先的端口，用来处理完后回调给原来的端口</span><br><span class="line">    KSLOG_DEBUG(&quot;Backing up original exception ports.&quot;);</span><br><span class="line">    kr &#x3D; task_get_exception_ports(thisTask,</span><br><span class="line">                                  mask,</span><br><span class="line">                                  g_previousExceptionPorts.masks,</span><br><span class="line">                                  &amp;g_previousExceptionPorts.count,</span><br><span class="line">                                  g_previousExceptionPorts.ports,</span><br><span class="line">                                  g_previousExceptionPorts.behaviors,</span><br><span class="line">                                  g_previousExceptionPorts.flavors);</span><br><span class="line">    if(kr !&#x3D; KERN_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        KSLOG_ERROR(&quot;task_get_exception_ports: %s&quot;, mach_error_string(kr));</span><br><span class="line">        goto failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(g_exceptionPort &#x3D;&#x3D; MACH_PORT_NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        KSLOG_DEBUG(&quot;Allocating new port with receive rights.&quot;);</span><br><span class="line">        kr &#x3D; mach_port_allocate(thisTask,</span><br><span class="line">                                MACH_PORT_RIGHT_RECEIVE,</span><br><span class="line">                                &amp;g_exceptionPort);</span><br><span class="line">        if(kr !&#x3D; KERN_SUCCESS)</span><br><span class="line">        &#123;</span><br><span class="line">            KSLOG_ERROR(&quot;mach_port_allocate: %s&quot;, mach_error_string(kr));</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        KSLOG_DEBUG(&quot;Adding send rights to port.&quot;);</span><br><span class="line">        kr &#x3D; mach_port_insert_right(thisTask,</span><br><span class="line">                                    g_exceptionPort,</span><br><span class="line">                                    g_exceptionPort,</span><br><span class="line">                                    MACH_MSG_TYPE_MAKE_SEND);</span><br><span class="line">        if(kr !&#x3D; KERN_SUCCESS)</span><br><span class="line">        &#123;</span><br><span class="line">            KSLOG_ERROR(&quot;mach_port_insert_right: %s&quot;, mach_error_string(kr));</span><br><span class="line">            goto failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    KSLOG_DEBUG(&quot;Installing port as exception handler.&quot;);</span><br><span class="line">    kr &#x3D; task_set_exception_ports(thisTask,</span><br><span class="line">                                  mask,</span><br><span class="line">                                  g_exceptionPort,</span><br><span class="line">                                  (int)(EXCEPTION_DEFAULT | MACH_EXCEPTION_CODES),</span><br><span class="line">                                  THREAD_STATE_NONE);</span><br><span class="line">    if(kr !&#x3D; KERN_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        KSLOG_ERROR(&quot;task_set_exception_ports: %s&quot;, mach_error_string(kr));</span><br><span class="line">        goto failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    KSLOG_DEBUG(&quot;Creating secondary exception thread (suspended).&quot;);</span><br><span class="line">    pthread_attr_init(&amp;attr);</span><br><span class="line">    attributes_created &#x3D; true;</span><br><span class="line">    pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);</span><br><span class="line">    error &#x3D; pthread_create(&amp;g_secondaryPThread,</span><br><span class="line">                           &amp;attr,</span><br><span class="line">                           &amp;handleExceptions,</span><br><span class="line">                           (void*)kThreadSecondary);</span><br><span class="line">    if(error !&#x3D; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        KSLOG_ERROR(&quot;pthread_create_suspended_np: %s&quot;, strerror(error));</span><br><span class="line">        goto failed;</span><br><span class="line">    &#125;</span><br><span class="line">    g_secondaryMachThread &#x3D; pthread_mach_thread_np(g_secondaryPThread);</span><br><span class="line">    ksmc_addReservedThread(g_secondaryMachThread);</span><br><span class="line"></span><br><span class="line">    KSLOG_DEBUG(&quot;Creating primary exception thread.&quot;);</span><br><span class="line">    error &#x3D; pthread_create(&amp;g_primaryPThread,</span><br><span class="line">                           &amp;attr,</span><br><span class="line">                           &amp;handleExceptions,</span><br><span class="line">                           (void*)kThreadPrimary);</span><br><span class="line">    if(error !&#x3D; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        KSLOG_ERROR(&quot;pthread_create: %s&quot;, strerror(error));</span><br><span class="line">        goto failed;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_attr_destroy(&amp;attr);</span><br><span class="line">    g_primaryMachThread &#x3D; pthread_mach_thread_np(g_primaryPThread);</span><br><span class="line">    ksmc_addReservedThread(g_primaryMachThread);</span><br><span class="line"></span><br><span class="line">    KSLOG_DEBUG(&quot;Mach exception handler installed.&quot;);</span><br><span class="line">    return true;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line">    KSLOG_DEBUG(&quot;Failed to install mach exception handler.&quot;);</span><br><span class="line">    if(attributes_created)</span><br><span class="line">    &#123;</span><br><span class="line">        pthread_attr_destroy(&amp;attr);</span><br><span class="line">    &#125;</span><br><span class="line">    uninstallExceptionHandler();</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-处理异常"><a href="#2-处理异常" class="headerlink" title="2. 处理异常"></a>2. 处理异常</h2></li>
<li>在for(;;)循环中等待mach消息，处理异常的线程不会一直执行 mach_msg会等待消息</li>
<li>抓取异常</li>
<li>ksmc_suspendEnvironment 挂起所有线程除异常处理线程之外<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** Our exception handler thread routine.</span><br><span class="line"> * Wait for an exception message, uninstall our exception port, record the</span><br><span class="line"> * exception information, and write a report.</span><br><span class="line"> *&#x2F;</span><br><span class="line"> &#x2F; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">&#x2F;** A mach exception message (according to ux_exception.c, xnu-1699.22.81).</span><br><span class="line"> *&#x2F;</span><br><span class="line">#pragma pack(4)</span><br><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;** Mach header. *&#x2F;</span><br><span class="line">    mach_msg_header_t          header;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Start of the kernel processed data.</span><br><span class="line"></span><br><span class="line">    &#x2F;** Basic message body data. *&#x2F;</span><br><span class="line">    mach_msg_body_t            body;</span><br><span class="line"></span><br><span class="line">    &#x2F;** The thread that raised the exception. *&#x2F;</span><br><span class="line">    mach_msg_port_descriptor_t thread;</span><br><span class="line"></span><br><span class="line">    &#x2F;** The task that raised the exception. *&#x2F;</span><br><span class="line">    mach_msg_port_descriptor_t task;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; End of the kernel processed data.</span><br><span class="line"></span><br><span class="line">    &#x2F;** Network Data Representation. *&#x2F;</span><br><span class="line">    NDR_record_t               NDR;</span><br><span class="line"></span><br><span class="line">    &#x2F;** The exception that was raised. *&#x2F;</span><br><span class="line">    exception_type_t           exception;</span><br><span class="line"></span><br><span class="line">    &#x2F;** The number of codes. *&#x2F;</span><br><span class="line">    mach_msg_type_number_t     codeCount;</span><br><span class="line"></span><br><span class="line">    &#x2F;** Exception code and subcode. *&#x2F;</span><br><span class="line">    &#x2F;&#x2F; ux_exception.c defines this as mach_exception_data_t for some reason.</span><br><span class="line">    &#x2F;&#x2F; But it&#39;s not actually a pointer; it&#39;s an embedded array.</span><br><span class="line">    &#x2F;&#x2F; On 32-bit systems, only the lower 32 bits of the code and subcode</span><br><span class="line">    &#x2F;&#x2F; are valid.</span><br><span class="line">    mach_exception_data_type_t code[0];</span><br><span class="line"></span><br><span class="line">    &#x2F;** Padding to avoid RCV_TOO_LARGE. *&#x2F;</span><br><span class="line">    char                       padding[512];</span><br><span class="line">&#125; MachExceptionMessage;</span><br><span class="line">&#x2F;&#x2F; 处理异常</span><br><span class="line">static void* handleExceptions(void* const userData)</span><br><span class="line">&#123;</span><br><span class="line">    MachExceptionMessage exceptionMessage &#x3D; &#123;&#123;0&#125;&#125;;</span><br><span class="line">    MachReplyMessage replyMessage &#x3D; &#123;&#123;0&#125;&#125;;</span><br><span class="line">    char* eventID &#x3D; g_primaryEventID;</span><br><span class="line"></span><br><span class="line">    const char* threadName &#x3D; (const char*) userData;</span><br><span class="line">    pthread_setname_np(threadName);</span><br><span class="line">    if(threadName &#x3D;&#x3D; kThreadSecondary)</span><br><span class="line">    &#123;</span><br><span class="line">        KSLOG_DEBUG(&quot;This is the secondary thread. Suspending.&quot;);</span><br><span class="line">        thread_suspend((thread_t)ksthread_self());</span><br><span class="line">        eventID &#x3D; g_secondaryEventID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        KSLOG_DEBUG(&quot;Waiting for mach exception&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Wait for a message.</span><br><span class="line">        kern_return_t kr &#x3D; mach_msg(&amp;exceptionMessage.header,</span><br><span class="line">                                    MACH_RCV_MSG,</span><br><span class="line">                                    0,</span><br><span class="line">                                    sizeof(exceptionMessage),</span><br><span class="line">                                    g_exceptionPort,</span><br><span class="line">                                    MACH_MSG_TIMEOUT_NONE,</span><br><span class="line">                                    MACH_PORT_NULL);</span><br><span class="line">        if(kr &#x3D;&#x3D; KERN_SUCCESS)</span><br><span class="line">        &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Loop and try again on failure.</span><br><span class="line">        KSLOG_ERROR(&quot;mach_msg: %s&quot;, mach_error_string(kr));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    KSLOG_DEBUG(&quot;Trapped mach exception code 0x%llx, subcode 0x%llx&quot;,</span><br><span class="line">                exceptionMessage.code[0], exceptionMessage.code[1]);</span><br><span class="line">    if(g_isEnabled)</span><br><span class="line">    &#123;</span><br><span class="line">        thread_act_array_t threads &#x3D; NULL;</span><br><span class="line">        mach_msg_type_number_t numThreads &#x3D; 0;</span><br><span class="line">        &#x2F;&#x2F;&#x2F;挂起所有的线程</span><br><span class="line">        ksmc_suspendEnvironment(&amp;threads, &amp;numThreads);</span><br><span class="line">        g_isHandlingCrash &#x3D; true;</span><br><span class="line">        kscm_notifyFatalExceptionCaptured(true);</span><br><span class="line"></span><br><span class="line">        KSLOG_DEBUG(&quot;Exception handler is installed. Continuing exception handling.&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Switch to the secondary thread if necessary, or uninstall the handler</span><br><span class="line">        &#x2F;&#x2F; to avoid a death loop.</span><br><span class="line">        if(ksthread_self() &#x3D;&#x3D; g_primaryMachThread)</span><br><span class="line">        &#123;</span><br><span class="line">            KSLOG_DEBUG(&quot;This is the primary exception thread. Activating secondary thread.&quot;);</span><br><span class="line">&#x2F;&#x2F; TODO: This was put here to avoid a freeze. Does secondary thread ever fire?</span><br><span class="line">            restoreExceptionPorts();</span><br><span class="line">            if(thread_resume(g_secondaryMachThread) !&#x3D; KERN_SUCCESS)</span><br><span class="line">            &#123;</span><br><span class="line">                KSLOG_DEBUG(&quot;Could not activate secondary thread. Restoring original exception ports.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            KSLOG_DEBUG(&quot;This is the secondary exception thread.&quot;);&#x2F;&#x2F; Restoring original exception ports.&quot;);</span><br><span class="line">&#x2F;&#x2F;            restoreExceptionPorts();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Fill out crash information</span><br><span class="line">        KSLOG_DEBUG(&quot;Fetching machine state.&quot;);</span><br><span class="line">        KSMC_NEW_CONTEXT(machineContext);</span><br><span class="line">        KSCrash_MonitorContext* crashContext &#x3D; &amp;g_monitorContext;</span><br><span class="line">        crashContext-&gt;offendingMachineContext &#x3D; machineContext;</span><br><span class="line">        kssc_initCursor(&amp;g_stackCursor, NULL, NULL);</span><br><span class="line">        if(ksmc_getContextForThread(exceptionMessage.thread.name, machineContext, true))</span><br><span class="line">        &#123;</span><br><span class="line">            kssc_initWithMachineContext(&amp;g_stackCursor, KSSC_MAX_STACK_DEPTH, machineContext);</span><br><span class="line">            KSLOG_TRACE(&quot;Fault address %p, instruction address %p&quot;,</span><br><span class="line">                        kscpu_faultAddress(machineContext), kscpu_instructionAddress(machineContext));</span><br><span class="line">            if(exceptionMessage.exception &#x3D;&#x3D; EXC_BAD_ACCESS)</span><br><span class="line">            &#123;</span><br><span class="line">                crashContext-&gt;faultAddress &#x3D; kscpu_faultAddress(machineContext);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                crashContext-&gt;faultAddress &#x3D; kscpu_instructionAddress(machineContext);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        KSLOG_DEBUG(&quot;Filling out context.&quot;);</span><br><span class="line">        crashContext-&gt;crashType &#x3D; KSCrashMonitorTypeMachException;</span><br><span class="line">        crashContext-&gt;eventID &#x3D; eventID;</span><br><span class="line">        crashContext-&gt;registersAreValid &#x3D; true;</span><br><span class="line">        crashContext-&gt;mach.type &#x3D; exceptionMessage.exception;</span><br><span class="line">        crashContext-&gt;mach.code &#x3D; exceptionMessage.code[0] &amp; (int64_t)MACH_ERROR_CODE_MASK;</span><br><span class="line">        crashContext-&gt;mach.subcode &#x3D; exceptionMessage.code[1] &amp; (int64_t)MACH_ERROR_CODE_MASK;</span><br><span class="line">        if(crashContext-&gt;mach.code &#x3D;&#x3D; KERN_PROTECTION_FAILURE &amp;&amp; crashContext-&gt;isStackOverflow)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; A stack overflow should return KERN_INVALID_ADDRESS, but</span><br><span class="line">            &#x2F;&#x2F; when a stack blasts through the guard pages at the top of the stack,</span><br><span class="line">            &#x2F;&#x2F; it generates KERN_PROTECTION_FAILURE. Correct for this.</span><br><span class="line">            crashContext-&gt;mach.code &#x3D; KERN_INVALID_ADDRESS;</span><br><span class="line">        &#125;</span><br><span class="line">        crashContext-&gt;signal.signum &#x3D; signalForMachException(crashContext-&gt;mach.type, crashContext-&gt;mach.code);</span><br><span class="line">        crashContext-&gt;stackCursor &#x3D; &amp;g_stackCursor;</span><br><span class="line"></span><br><span class="line">        kscm_handleException(crashContext);</span><br><span class="line"></span><br><span class="line">        KSLOG_DEBUG(&quot;Crash handling complete. Restoring original handlers.&quot;);</span><br><span class="line">        g_isHandlingCrash &#x3D; false;</span><br><span class="line">        ksmc_resumeEnvironment(threads, numThreads);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    KSLOG_DEBUG(&quot;Replying to mach exception message.&quot;);</span><br><span class="line">    &#x2F;&#x2F; Send a reply saying &quot;I didn&#39;t handle this exception&quot;.</span><br><span class="line">    replyMessage.header &#x3D; exceptionMessage.header;</span><br><span class="line">    replyMessage.NDR &#x3D; exceptionMessage.NDR;</span><br><span class="line">    replyMessage.returnCode &#x3D; KERN_FAILURE;</span><br><span class="line"></span><br><span class="line">    mach_msg(&amp;replyMessage.header,</span><br><span class="line">             MACH_SEND_MSG,</span><br><span class="line">             sizeof(replyMessage),</span><br><span class="line">             0,</span><br><span class="line">             MACH_PORT_NULL,</span><br><span class="line">             MACH_MSG_TIMEOUT_NONE,</span><br><span class="line">             MACH_PORT_NULL);</span><br><span class="line"></span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="LLDB-Debugger"><a href="#LLDB-Debugger" class="headerlink" title="LLDB Debugger"></a>LLDB Debugger</h2><p>__unsafe_unretained NSObject *objc = [[NSObject alloc] init];<br>    NSLog(@”✳️✳️✳️ objc: %@”, objc)<br> ARC 下会发生 EXC_BAD_ACCESS 异常，这里要注意一下，只有我们关闭 xcode 的 Debug executable 选项才能收到 exc_handler 回调</p>
<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><ol>
<li>Q:添加mac异常自定义处理是如何将线程和端口绑定<br>在异常处理线程等待异常端口的消息<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">KSLOG_DEBUG(&quot;Installing port as exception handler.&quot;);</span><br><span class="line">    kr &#x3D; task_set_exception_ports(thisTask,</span><br><span class="line">                                  mask,</span><br><span class="line">                                  g_exceptionPort,</span><br><span class="line">                                  (int)(EXCEPTION_DEFAULT | MACH_EXCEPTION_CODES),</span><br><span class="line">                                  THREAD_STATE_NONE);</span><br><span class="line"></span><br><span class="line">KSLOG_DEBUG(&quot;Creating primary exception thread.&quot;);</span><br><span class="line">    error &#x3D; pthread_create(&amp;g_primaryPThread,git</span><br><span class="line">                           &amp;attr,</span><br><span class="line">                           &amp;handleExceptions,</span><br><span class="line">                           (void*)kThreadPrimary); --&gt;</span><br></pre></td></tr></table></figure>


</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://blog.csdn.net/yxccc_914/article/details/79854603" target="_blank" rel="noopener">MAC OS 的mach_port_t和pthread_self()</a> <br><br><a href="https://developer.aliyun.com/article/499180" target="_blank" rel="noopener">iOS Mach异常和signal信号</a><br><br><a href="https://blog.csdn.net/killer1989/article/details/106674973" target="_blank" rel="noopener">获取线程ID有更好的方式吗</a><br></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://393698063.github.io/2021/12/29/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-2%20Mach%20kerner%20execption/" data-id="claw83fq20000ab9jgc3nerc1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="page/2/">2</a><a class="extend next" rel="next" href="page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="2022/09/27/MetricKIt%E7%9B%91%E6%8E%A7APP%E6%80%A7%E8%83%BD/">MetricKIt监控APP性能</a>
          </li>
        
          <li>
            <a href="2022/08/25/%E6%9A%97%E9%BB%91%E6%A8%A1%E5%BC%8F%E4%B8%80/">暗黑模式一</a>
          </li>
        
          <li>
            <a href="2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-6-zoombie-class/">KSCrash-源码阅读-6 zoombie_class</a>
          </li>
        
          <li>
            <a href="2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-5-Dead-lock/">KSCrash-源码阅读-5 Dead lock</a>
          </li>
        
          <li>
            <a href="2022/04/11/KSCrash-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-5-C-Exception/">KSCrash-源码阅读-5 C++ Exception</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 jorgon<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="index.html" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="fancybox/jquery.fancybox.css">

  
<script src="fancybox/jquery.fancybox.pack.js"></script>




<script src="js/script.js"></script>




  </div>
</body>
</html>